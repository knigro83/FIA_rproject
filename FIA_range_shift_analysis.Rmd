---
title: "FIA Range Shift Analysis"
author: "Katie Nigro"
date: "March 9, 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set-up

These are the packages I need:

```{r,message=FALSE,warning=FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(plyr)
library(purrr)
library(DT)
library(ggplot2)
library(ggfortify)
library(ggpubr)
library(leaflet)
library(mapdata)
library(car)
library(ggmap)
library(fitdistrplus)
library(logspline)
```

Let's first read in the data.

```{r,warning=FALSE,message=FALSE}
##read in FIA tree & regen data 
tree<- read_csv("TREE.csv")
seedling<- read_csv("SEEDLING.csv")
plot<- read_csv("annual_plots2020.csv")

##read in environmental vars
env_vars <- read_csv("env_vars_FIA.csv")
```

Now I will summarise the number of adults and seedlings of each species in each plot.

```{r,echo=FALSE,warning=FALSE,message=FALSE, results='hide'}
adults <- tree %>% 
  group_by(SPCD,PLT_CN) %>% 
  dplyr::summarise(n = n())

head(adults)

seeds <- seedling %>% 
  group_by(SPCD, PLT_CN) %>% 
  dplyr::summarise(n = n())

head(seeds)
```

```{r,warning=FALSE, message=FALSE, echo=FALSE}
##read in plots by disturbance type
fire<- read_csv("fire.plots2020.csv")
ID<- read_csv("insect.disease.plots2020.csv")
harvest<- read_csv("harvest.plots2020.csv")
other<- read_csv("other.plots2020.csv")
undis<- read_csv("undisturbed.plots2020.csv")

dist <- bind_rows(fire,ID,harvest,other,undis)
```

Join disturbance data with adult and seedling dataframes. There are NA's in the data because the adults and seeds dataframes have all plots, where as the disturbance dataframe only has plots that met my criteria. So this is ok.

```{r,echo=FALSE}
dist_adults_joined <- left_join(adults, dist, by="PLT_CN")
head(dist_adults_joined)
summary(is.na(dist_adults_joined)) #there are NAs for the plots that are not in my analysis, this is ok 

dist_seeds_joined <- left_join(seeds, dist, by="PLT_CN")
head(dist_seeds_joined)
summary(is.na(dist_seeds_joined)) #there are NAs for the plots that are not in my analysis, this is ok 

```

I will use both the most recent surveys and the previous survey (if applicable) to tally adult presence at a plot. If the adult of a species was present in at least one of the surveys, that plot will be counted as having adults of that species present. 
```{r, echo=FALSE, results='hide'}
### count plots as containing adults if either the most current survey OR the previous survey documented the species ###

#make data frame linking most recent plot CN to previous plot CN
recent.plots <- dist %>% 
                  dplyr::select("PLT_CN")

plot_progression <- left_join(recent.plots, plot, by=c("PLT_CN"="CN")) %>% 
                      dplyr::select(c("PLT_CN","PREV_PLT_CN")) %>% 
                        left_join(plot, by=c("PREV_PLT_CN"="CN")) %>% 
                          dplyr::select(c("PLT_CN","PREV_PLT_CN","PREV_PLT_CN.y"))

#make datatable with species recorded in most recent survey (SPCD) and in the previous survey (SPCD.prev)
prev_plot_spp <- plot_progression %>% 
  filter(!is.na(PREV_PLT_CN)) %>% 
  dplyr::select("PREV_PLT_CN") %>% 
  left_join(adults, by=c("PREV_PLT_CN" = "PLT_CN")) %>% 
  left_join(plot_progression, by="PREV_PLT_CN") %>% 
  dplyr::rename(SPCD.prev = SPCD, n.prev = n) %>% 
  right_join(dist_adults_joined, by="PLT_CN") %>% 
  filter(!is.na(Agent))

length(unique(prev_plot_spp$PREV_PLT_CN))
length(unique(prev_plot_spp$PLT_CN))

#looking at differences in species codes between recent and previous surveys
species.sum <- prev_plot_spp %>% 
  group_by(PLT_CN, Agent) %>% 
  dplyr::summarise(spp = toString(unique(SPCD)),spp.prev = toString(unique(SPCD.prev)))
#look at just plots where species differ between recent and previous surveys
species.sum %>% 
       filter(!spp == spp.prev)

## melt dataframe so that all species are listed under "SPCD", whether identified in most recent survey or previous survey. Clean up the dataframe by removing unneccesary columns. Then remove duplicated rows that were created when recent survey was fully joined with previous survey 
species.sum.long<- prev_plot_spp %>% 
  gather(key=period, value=SPCD, SPCD.prev, SPCD) %>% 
  dplyr::select(-one_of(c("n.prev","PREV_PLT_CN.y.y","n","period"))) %>% 
  distinct()
```

This plot shows the number of trees with STATUS codes of 0-3 across all plots used in the analysis, separated by disturbance category. Status codes are as follows:

* 0 no status. Tree is not in sample because either it was incorrectly tallied in the last sample, not currently tallied due to procedural change, or natural causes. 
* 1 live
* 2 dead
* 3 removed by human activity 

Burned plots had the most dead trees (50%), followed by insect/disease (33%), harvest (17%) and none (15%). Harvested plots also had 3% of trees classified as “removed”.
```{r, echo=FALSE}
#look at tree status codes
tree.status <- dist %>% 
  left_join(tree, by="PLT_CN") %>% 
  group_by(Agent) %>%
  filter(!is.na(STATUSCD)) %>% 
  dplyr::summarise(count(STATUSCD))

ggplot(tree.status, aes(x=Agent, y=freq, fill=factor(x)))+
  geom_bar(position = "fill", stat = "identity")+
  scale_y_continuous(labels = scales::percent_format())+
  scale_fill_brewer(palette = "Set1")
# 0 = no status (tree not presently in the sample), 1 = live, 2 = dead, 3 = removed
```

```{r, echo=FALSE, results='hide'}
#percent of harvested plots with status = 3
tree.status %>% 
  filter(Agent == "harvest", x == 3) %>% 
  pluck("freq") /
tree.status %>% 
  filter(Agent == "harvest") %>% 
  pull("freq") %>% 
  sum()*100
#percent of harvested plots with status = 2
tree.status %>% 
  filter(Agent == "harvest", x == 2) %>% 
  pluck("freq") /
tree.status %>% 
  filter(Agent == "harvest") %>% 
  pull("freq") %>% 
  sum()*100
#percent of ID plots with status = 2
tree.status %>% 
  filter(Agent == "insect.disease", x == 2) %>% 
  pluck("freq") /
tree.status %>% 
  filter(Agent == "insect.disease") %>% 
  pull("freq") %>% 
  sum()*100
#percent of none plots with status = 2
tree.status %>% 
  filter(Agent == "none", x == 2) %>% 
  pluck("freq") /
tree.status %>% 
  filter(Agent == "none") %>% 
  pull("freq") %>% 
  sum()*100
```

The histogram below displays the year that plots in the analysis were measured. Some plots were measured twice, and we used both surveys to detect adult presence. These plots have both the recent survey year (all between 2010-2018) and the previous survey year (all between 2000-2013) displayed in the histogram. Some plots were only surveyed once, and their year of measurement is shown in pink (surveyed between 1995-2018). The second histogram displays the difference in years between the first and second survey for all plots that were surveyed twice.  

```{r, echo=FALSE}
##look at when recent vs. previous surveys were done
timeline <- left_join(recent.plots, plot, by=c("PLT_CN"="CN")) %>% 
                      dplyr::select(c("PLT_CN","PREV_PLT_CN","MEASYEAR")) %>% 
                        left_join(plot, by=c("PREV_PLT_CN"="CN")) %>% 
                          dplyr::select(c("PLT_CN","PREV_PLT_CN","MEASYEAR.x","MEASYEAR.y")) %>% 
                            dplyr::rename(MEASYEAR.rec = MEASYEAR.x, MEASYEAR.prev = MEASYEAR.y) %>% 
                              dplyr::mutate(year.diff = MEASYEAR.rec - MEASYEAR.prev) 
par(mfrow=c(1,1))
#####histogram of 3 plot time periods
hist(timeline[is.na(timeline$PREV_PLT_CN),]$MEASYEAR.rec,col=rgb(1,0,0,0.5),breaks=24, main="Histogram of plot measurement year",xlab="Measurement Year") #plots that didn't have a previous survey were surveyed from 1995 - 2018
hist(timeline[!is.na(timeline$PREV_PLT_CN),]$MEASYEAR.rec,col=rgb(0,0,1,0.3),breaks=9,add=TRUE) #all plots that had a previous survey had their most recent survey between 2010 - 2018
hist(timeline$MEASYEAR.prev, col=rgb(1,1,0,0.2),breaks=14, add=TRUE) #previous surveys were all measured between 2000 - 2013
legend("topright",legend=c("MEASYEAR of plots with only 1 survey","recent MEASYEAR of plots with 2 surveys", "previous MEASYEAR of plots with 2 surveys"),fill=c(rgb(1,0,0,0.5),rgb(0,0,1,0.3),rgb(1,1,0,0.2)))
######

##number of plots in each category
length(timeline[is.na(timeline$PREV_PLT_CN),]$MEASYEAR.rec) #plots that didn't have a previous survey 
length(timeline[!is.na(timeline$PREV_PLT_CN),]$MEASYEAR.rec) #plots that had a previous survey 
24628/(24628+34828)

##difference in years between first and second survey
par(mfrow=c(1,1))
hist(timeline$year.diff)
```

Here are tables of sample sizes for each species and disturbance type. The first shows adult sample sizes and the second shows seedling sample sizes.

```{r, echo=FALSE,warning=FALSE,message=FALSE}
#calculate sample size for adults and seedlings
adult_sample_cmbsurv <- species.sum.long %>%
  filter(!is.na(SPCD)) %>% 
  group_by(SPCD, Agent) %>% 
  dplyr::summarise(n_plots = n_distinct(PLT_CN))
datatable(adult_sample_cmbsurv)

sample_seeds <- dist_seeds_joined %>% 
  filter(!is.na(Agent)) %>% 
  group_by(SPCD, Agent) %>% 
  dplyr::summarise(n_plots = n_distinct(PLT_CN))
datatable(sample_seeds, caption = "Seedling Sample Size")
```

Let's set the minimum number of plots at 30. There are 20 species in the FIA database that have 30 or more plots in each disturbance type with adults present, but only 12 species with seedlings present in 30+ plots per disturbance type. The species codes for those 12 species are as follows:

```{r, echo=FALSE,warning=FALSE}
#first make a dataframe to translate species codes to names
species.names <- data.frame(species.code = c(15,17,19,63,93,106,108,122,202,242,746,814), species.name = c("white fir","grand fir","subalpine fir","alligator juniper","Engelmann spruce","two needle pinyon","lodgepole pine","ponderosa pine","Douglas-fir","western redcedar","trembling aspen","Gambel oak"))

#filter sample size table to species with adults in at least 30 plots 
sample_adults_over30_cmb <- adult_sample_cmbsurv %>% 
  filter(n_plots >= 30) %>% 
  filter(!Agent == "other") %>% 
  group_by(SPCD) %>% 
  dplyr::summarise(dist_over30 = n_distinct(Agent)) %>% 
  filter(dist_over30 == 4) %>% 
  left_join(species.names, by=c("SPCD" = "species.code"))
```

```{r, echo=FALSE}
#do the same for seedlings
sample_seeds_over30 <- sample_seeds %>% 
  filter(n_plots >= 30) %>% 
  filter(!Agent == "other") %>% 
  group_by(SPCD) %>% 
  dplyr::summarise(dist_over50 = n_distinct(Agent)) %>% 
  filter(dist_over50 == 4) %>% 
  left_join(species.names, by=c("SPCD" = "species.code"))

  
datatable(sample_seeds_over30[,-2], caption="Seedlings in > 30 plots")
```

The histograms below show the distribution of recent (blue) and previous (green) measurement years for the plots where adults of each species were found. Below are histograms for the measurement year of plots where seedlings of each species were found.  
```{r, echo=FALSE}
spp_hist_data <- species.sum.long %>% 
  left_join(plot, by=c("PREV_PLT_CN" = "CN")) %>% 
  dplyr::select(c(PREV_PLT_CN:SPCD,MEASYEAR.y)) %>% 
  dplyr::rename("Prev.MEASYEAR" = "MEASYEAR.y")
dev.new()
par(mfrow=c(4,3))
for(i in 1:length(species.names$species.code)){
hist(spp_hist_data[spp_hist_data$SPCD==species.names$species.code[i],]$Rec.MEASYEAR, col=rgb(0,0,1,0.5), breaks=(max(spp_hist_data[which(spp_hist_data$SPCD==species.names$species.code[i] & !is.na(spp_hist_data$Rec.MEASYEAR)),]$Rec.MEASYEAR) - min(spp_hist_data[which(spp_hist_data$SPCD==species.names$species.code[i] & !is.na(spp_hist_data$Rec.MEASYEAR)),]$Rec.MEASYEAR))+1, main=paste("Histogram for",species.names$species.name[i],"adults",sep=" "),xlab="Measurement Year")
hist(spp_hist_data[spp_hist_data$SPCD==species.names$species.code[i],]$Prev.MEASYEAR, col=rgb(0,1,0,0.3), breaks=(max(spp_hist_data[which(spp_hist_data$SPCD==species.names$species.code[i] & !is.na(spp_hist_data$Prev.MEASYEAR)),]$Prev.MEASYEAR) - min(spp_hist_data[which(spp_hist_data$SPCD==species.names$species.code[i] & !is.na(spp_hist_data$Prev.MEASYEAR)),]$Prev.MEASYEAR))+1, add=TRUE)
}

```

```{r, echo=FALSE}
seed_hist_data <- dist_seeds_joined %>% 
  left_join(plot, by=c("PLT_CN" = "CN")) %>% 
  dplyr::select(c(SPCD:Rec.MEASYEAR,MEASYEAR.y)) %>% 
  filter(!is.na(Agent))

summary(seed_hist_data$MEASYEAR.y == seed_hist_data$Rec.MEASYEAR)

dev.new()
par(mfrow=c(4,3))
for(i in 1:length(species.names$species.code)){
hist(seed_hist_data[seed_hist_data$SPCD == species.names$species.code[i],]$MEASYEAR.y, col=rgb(0,0,1,0.5), breaks=(max(seed_hist_data[which(seed_hist_data$SPCD==species.names$species.code[i] & !is.na(seed_hist_data$Rec.MEASYEAR)),]$Rec.MEASYEAR) - min(seed_hist_data[which(seed_hist_data$SPCD==species.names$species.code[i] & !is.na(seed_hist_data$Rec.MEASYEAR)),]$Rec.MEASYEAR))+1,  main=paste("Histogram for",species.names$species.name[i],"seedlings",sep=" "),xlab="Measurement Year")
}
```

```{r, echo=FALSE}
##create function that appends climate data to each species/lifestage/disturbance

#' merge_sp_dist_env
#'
#' @param joined_df dataframe with disturbance and species data joined. Either species.sum.long or dist_seeds_joined
#' @param sp_code code for desired species. Can be found in FIA user guide. 
#' @param agent_name name of the desired disturbance. Either fire, insect.disease, harvest, other or none. 
#' @param env_vars environmental variables dataframe. Called env_vars here. 
#'
#' @return dataframe with environmental variables associated with each plot for a desired species/lifestage/disturbance combination 
#' @export
#'
#' @examples
merge_sp_dist_env <- function(joined_df, sp_code, agent_name, env_vars) {  sp_dist_env <- joined_df %>% 
    filter(SPCD == sp_code &
             Agent == agent_name) %>% 
    dplyr::select(SPCD, PLT_CN, Agent, DSTRBYR, source) %>% 
    left_join(env_vars, by = c("PLT_CN" = "X1"))
  
  return(sp_dist_env)
}
   
#FIA codes for all desired species (n=12) and disturbances (n=4)
sp_codes <- as.character(unique(sample_seeds_over30$SPCD))
dist_names <- c("fire","harvest","insect.disease","none")

#put environmental data for each species/disturbance combination in a dataframe within a list for adults
adult_data <- list()
for(i in 1:length(sp_codes)){
  for(j in 1:length(dist_names)){
    df <- merge_sp_dist_env(species.sum.long, sp_codes[i], dist_names[j], env_vars)
    adult_data[[paste(sp_codes[i],"_",dist_names[j],"_cvars",sep="")]]<- df
  }
}
#list for seedlings 
seedling_data <- list()
for(i in 1:length(sp_codes)){
  for(j in 1:length(dist_names)){
    df <- merge_sp_dist_env(dist_seeds_joined, sp_codes[i], dist_names[j], env_vars)
    seedling_data[[paste(sp_codes[i],"_",dist_names[j],"_cvars",sep="")]]<- df
  }
}
```

This is a sample size table for each species, age and disturbance

```{r,echo=FALSE}
sample_size<- data.frame()
for(i in 1:length(adult_data)){
  n.adult <- nrow(adult_data[[i]])
  n.seed <- nrow(seedling_data[[i]])
  new.row <- data.frame(name=paste(names(adult_data)[i]),n.adult=n.adult, n.seed)
  sample_size <- bind_rows(name=sample_size,n = new.row)
}
sample_size <- sample_size %>% 
  separate(name, c("species","agent"),sep="_",extra="drop") %>%
  mutate(species = as.numeric(species)) %>% 
  left_join(species.names,by=c("species" = "species.code"))

datatable(sample_size[,-1])
```

And the below plots show sample size for each species within each disturbance type graphically. 

```{r}
ggplot(sample_size,aes(x=agent, y=n.adult, fill=species.name))+
  geom_bar(stat='identity',position='dodge2')+
  ggtitle("Number of plots with Adults")+
  xlab("")+ylab("# plots")

ggplot(sample_size,aes(x=agent, y=n.seed, fill=species.name))+
  geom_bar(stat='identity',position='dodge2')+
  ggtitle("Number of plots with Seedlings")+
  xlab("")+ylab("# plots")

```

# Multivariate Analysis

##Principal Components Analysis

I will first run a principal components analysis (PCA) on a suite of climate variables for all plots included in the analysis (n = 59,456). Climate variables were collected from PRISM and [ClimateWNA] (<https://sites.ualberta.ca/~ahamann/data/climatewna.html>). First I will evaluate which climate variables are highty correlated (\>0.9) and only keep one of each highly correlated pair.

```{r, echo = FALSE,eval=FALSE}
#first look at correlations in climate variables
colnames(env_vars)
```

```{r, echo=FALSE}
env_vars %>% 
  dplyr::select(-X1,-FIA_slope,-FIA_elev,-foldedaspect,-TD) %>% 
  filter(! is.na(awc.total)) %>% 
  cor() %>% 
  abs()>0.9

env_vars_cut <- env_vars %>% 
  dplyr::select(-X1,-FIA_slope,-FIA_elev,-foldedaspect,-TD, -ppt, -tmean, -tmax, - tmin, -vpdmin, -vpdmax, -MWMT, -AHM, -DD5, -bFFP, -eFFP, -EMT, -Eref, -Tave_wt, -Tave_sm, -PPT_sm, -awc.total)
```

```{r,eval=FALSE,echo=FALSE}
#look at linearity of relationships
ncol(env_vars_cut)
pairs(env_vars_cut, lower.panel = NULL)
```

```{r, echo=FALSE,echo=FALSE}
##log-transform precipitation variables to make relationships between climate variables more linear 
env_vars_cut_trans <- env_vars_cut %>% 
  mutate(MSP_log = log(MSP),SHM_log = log(SHM), PPT_wt_log = log(PPT_wt), PAS_log = log(PAS+0.999), DD_0_log = log(DD_0), .keep="unused")
```

```{r,eval=FALSE}
#check linearity of relationships with plots
#these take a while to produce
pairs(env_vars_cut_trans, lower.panel=NULL)
```

After removing some variables due to high correlation, some of the precipitation variables were log-transformed to make relationships linear, which is an assumption of PCA. The climate variable codes which were kept and their definitions are as follows:

-   CMD: climate moisture deficit
-   DD_0: degree days below 0 degrees Celsius
-   MCMT: mean temperature of the coldest month (Celsius)
-   MSP_log: log-transformed mean summer (May - Sept) precipitation (mm)
-   NFFD: number of frost-free degree days
-   PAS_log: log-transformed precipitation as snow (mm)
-   PPT_wt_log: log-transformed winter (Dec - Feb) precipitation (mm)
-   SHM_log: log-transformed summer heat moisture index (mean temperature of the warmest month/ (mean summer precipitation/1000))

After running the PCA on these variables, we see that the first two components capture 88% of the variability in climate data.

```{r, echo = FALSE}
#run the PCA on transformed climate variables
set.seed(83)
clim_pca <- prcomp(env_vars_cut_trans,scale.=T) #proceed from correlation matrix, which scales variables--important because our variables have different units
summary(clim_pca)
plot(clim_pca,type="l")
```

The variables most strongly correlated with PC1 are climate moisture deficit (CMD), precipitation as snow (PAS), number of frost free degree days (NFFD), degree days below zero (DD_0), and mean temperature of the coldest month (MCMT). The variables most strongly correlated with PC2 are mean summer precipitation (MSP) and winter precipitation (PPT_wt). So, PC1 seems to be a temperature related axis, while PC2 corresponds to precipitation.

```{r}
clim_pca$rotation[,1:2]
```

```{r, echo=FALSE}
#plot pca and climate variable loadings
autoplot(clim_pca,x=1,y=2,colour="grey",loadings.colour="black", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.vjust=-1.5, loadings.label.size=3, alpha=0.5)+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11))
```

```{r, echo = FALSE}
#make dataframe with PCA coordinates of all plots 
clim_pca_points <- as.data.frame(clim_pca$x)
clim_pca_points <- clim_pca_points %>% 
  bind_cols(plot = env_vars$X1)

#left join the positions on the PCA for adults and seedlings in all disturbance types by their plot ID #s
adult_data_pcapts <-
  map2( .x = seq_along( along.with = adult_data )
        , .y = adult_data
        , .f = function( i, j )
          {
          left_join( x = j, 
                     y = clim_pca_points, 
                     by=c("PLT_CN" = "plot") )
          })
names(adult_data_pcapts)<- names(adult_data)

seedling_data_pcapts <-
  map2( .x = seq_along( along.with = seedling_data )
        , .y = seedling_data
        , .f = function( i, j )
          {
          left_join( x = j, 
                     y = clim_pca_points, 
                     by=c("PLT_CN" = "plot") )
          })
names(seedling_data_pcapts) <- names(seedling_data)

```

```{r,echo=FALSE, eval=FALSE}
#make example plot for presentation highlighting species presence on the PCA
autoplot(clim_pca,x=1,y=2,colour="grey",loadings.colour="black", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.vjust=-1.5, loadings.label.size=3, alpha=0.5)+
  geom_point(data=adult_data_pcapts[[26]],aes(x=PC1,y=PC2),color="red4")+
  geom_point(data=seedling_data_pcapts[[26]],aes(x=PC1,y=PC2),color="red")+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11))

autoplot(clim_pca,x=1,y=2,colour="grey",loadings.colour="black", loadings=T, loadings.label=T, loadings.label.colour="black", scale=0, loadings.label.vjust=-1.5, loadings.label.size=3, alpha=0.5)+
  geom_point(data=seedling_data_pcapts[[26]],aes(x=PC1,y=PC2),color="pink")+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11))

```

These boxplots display the range of PC1 and PC2 coordinates that plots within each disturbance category occupy. The disturbances are pretty evenly distributed across climate space, with insect/disease and harvest occupying slightly higher values on PC1 and lower values on PC2, which correspond to cooler and wetter climates, and undisturbed and fire plots occupying slightly lower values on PC1 and higher values on PC2, corresponding to warmer and drier climates.

```{r, echo=FALSE}
#summarize position on PC1 and 2 of plots in each disturbance category. 
pca_pts_by_dist <- clim_pca_points %>% 
  left_join(dist, by=c("plot" = "PLT_CN"))

ggplot(pca_pts_by_dist[which(! pca_pts_by_dist$Agent == "other"),], aes(x=Agent,y=PC1,fill=Agent))+
  geom_boxplot()+
  theme_bw()

#significant differnces in disturbances? yes
pc1.agent.mod <- aov(PC1~Agent, data=pca_pts_by_dist)
summary(pc1.agent.mod)
TukeyHSD(pc1.agent.mod)

pc2.agent.mod <- aov(PC2~Agent, data=pca_pts_by_dist)
summary(pc2.agent.mod)
TukeyHSD(pc2.agent.mod)

ggplot(pca_pts_by_dist[which(! pca_pts_by_dist$Agent == "other"),], aes(x=Agent,y=PC2,fill=Agent))+
  geom_boxplot()+
  theme_bw()
```

##Effects of disturbance on range shifts across species 

###PC1
First I am going to look at whether changes in 5th, 50th and 95th percentiles of positions on both PC1 and PC2 were significantly different from zero across all species, for each disturbance type.

Let's look at changes in PC1, which corresponds most strongly with climatic moisture deficit (CMD) and temperature variables. Shifts in the negative direction on PC1 indicate shifts in the seedling climatic niche to hotter climates, whereas positive shifts would represent shifts in seedling niche to cooler climates.

```{r, warning = FALSE, echo = FALSE, results='hide'}
##### make function for calculating differences in quantiles of adults vs. seedlings
#' get_diff
#'
#' @param adult_data list of dataframes that are separated by species and agent. Dataframes contain info on climate variables of plots with adults of each species/agent.  
#' @param seedling_data list of dataframes that are separated by species and agent. Dataframes contain info on climate variables of plots with seedlings of each species/agent. 
#' @param var name of the desired climate variable for which the difference should be calculated. This can also be a principal component, or any column that exists in every dataframe in the list.  
#' @param quant The quantile for which you want to calculate the difference between adults and seedlings.
#'
#' @return a dataframe with the difference in chosen quantile between adults and seedlings, for the chosen climate variable, under each disturbance agent.  
#' @export
#'
#' @examples
get_diff <- function(adult_data, seedling_data, var,quant){
q.table = data.frame()
for(i in 1:length(names(adult_data))){
  adult.q<- adult_data %>% 
    pluck(names(adult_data)[i]) %>% 
    ungroup() %>% 
    dplyr::select(!!var) %>% 
    dplyr::summarise(quantile = quantile(!!var,probs = quant))
  seed.q<- seedling_data %>% 
    pluck(names(adult_data)[i]) %>% 
    ungroup() %>% 
    dplyr::select(!!var) %>% 
    dplyr::summarise(quantile = quantile(!!var,probs = quant))
  adult.95<- adult_data %>% 
    pluck(names(adult_data)[i]) %>% 
    ungroup() %>% 
    dplyr::select(!!var) %>% 
    dplyr::summarise(quantile = quantile(!!var,probs = 0.95))
  adult.05 <- adult_data %>% 
    pluck(names(adult_data)[i]) %>% 
    ungroup() %>% 
    dplyr::select(!!var) %>% 
    dplyr::summarise(quantile = quantile(!!var,probs = 0.05))
  adult.tolerance <- adult.95 - adult.05
  q_diff = (seed.q - adult.q)/adult.tolerance
  q.table <- bind_rows(q.table, data.frame(names(adult_data)[i],q_diff) )
}
q.table <- q.table %>% 
  dplyr::rename(!!paste("quant",quant*100,sep="_") := quantile,
         uid = names.adult_data..i.)
return(q.table) 
}
```

```{r, echo=FALSE, results='hide'}
#calculate difference in 5th, 50th and 95th percentiles in PC1 position between adults and seedlings of each species and disturbance type 
pc1.diffs.table <- data.frame(uid = names(adult_data_pcapts))
for(i in c(0.05, 0.5, 0.95)){
diffs <- get_diff(adult_data_pcapts, seedling_data_pcapts, quo(PC1), i) 
  pc1.diffs.table <- pc1.diffs.table %>% 
    left_join(diffs, by = "uid")
}

#get dataframe in order for analysis and plotting
pc1.diffs.sep <- pc1.diffs.table %>% 
  separate(uid, c("species","agent"),sep="_",remove=FALSE, extra="drop") %>% 
  mutate(species = as.numeric(species)) %>% 
  left_join(species.names,by=c("species" = "species.code"))
```

```{r, echo=FALSE, eval=FALSE, results="hide"}
##checking for normality
fire.diffs.pc1<- pc1.diffs.sep %>% 
  filter(agent == "fire")
harvest.diffs.pc1<- pc1.diffs.sep %>% 
  filter(agent == "harvest")
id.diffs.pc1<- pc1.diffs.sep %>% 
  filter(agent == "insect.disease")
none.diffs.pc1<- pc1.diffs.sep %>% 
  filter(agent == "none")

#fire 5th quantile
ggqqplot(fire.diffs.pc1$quant_5)
ggqqplot(fire.diffs.pc1$quant_5)
shapiro.test(fire.diffs.pc1$quant_5)

#fire 50th quantile
ggqqplot(fire.diffs.pc1$quant_50)
ggqqplot(fire.diffs.pc1$quant_50)
shapiro.test(fire.diffs.pc1$quant_50)

#fire 95th quantile
ggqqplot(fire.diffs.pc1$quant_95)
ggqqplot(fire.diffs.pc1$quant_95)
shapiro.test(fire.diffs.pc1$quant_95)

#harvest 5th quantile -- NOT NORMAL
ggqqplot(harvest.diffs.pc1$quant_5)
ggqqplot(harvest.diffs.pc1$quant_5)
shapiro.test(harvest.diffs.pc1$quant_5)

#harvest 50th quantile
ggqqplot(harvest.diffs.pc1$quant_50)
ggqqplot(harvest.diffs.pc1$quant_50)
shapiro.test(harvest.diffs.pc1$quant_50)

#harvest 95th quantile
ggqqplot(harvest.diffs.pc1$quant_95)
ggqqplot(harvest.diffs.pc1$quant_95)
shapiro.test(harvest.diffs.pc1$quant_95)

#id 5th quantile
ggqqplot(id.diffs.pc1$quant_5)
ggqqplot(id.diffs.pc1$quant_5)
shapiro.test(id.diffs.pc1$quant_5)

#id 50th quantile
ggqqplot(id.diffs.pc1$quant_50)
ggqqplot(id.diffs.pc1$quant_50)
shapiro.test(id.diffs.pc1$quant_50)

#id 95th quantile
ggqqplot(id.diffs.pc1$quant_95)
ggqqplot(id.diffs.pc1$quant_95)
shapiro.test(id.diffs.pc1$quant_95)

#none 5th quantile
ggqqplot(none.diffs.pc1$quant_5)
ggqqplot(none.diffs.pc1$quant_5)
shapiro.test(none.diffs.pc1$quant_5)

#none 50th quantile
ggqqplot(none.diffs.pc1$quant_50)
ggqqplot(none.diffs.pc1$quant_50)
shapiro.test(none.diffs.pc1$quant_50)

#none 95th quantile
ggqqplot(none.diffs.pc1$quant_95)
ggqqplot(none.diffs.pc1$quant_95)
shapiro.test(none.diffs.pc1$quant_95)

```

```{r,echo=FALSE, results="hide"}
###checking that paired t-test is same as one sample t-test on the differences - it is!!
fire.adults<- c()
for(i in seq(1,48,4)){
data<- adult_data_pcapts %>% 
    pluck(i) %>% 
    ungroup() %>% 
    dplyr::select(!!quo(PC1)) %>% 
    dplyr::summarise(quantile = quantile(!!quo(PC1),probs = 0.05)) %>% 
    pull()
fire.adults <- c(fire.adults, data)
}  

fire.adults95 <- c()
for(i in seq(1,48,4)){
data<- adult_data_pcapts %>% 
    pluck(i) %>% 
    ungroup() %>% 
    dplyr::select(!!quo(PC1)) %>% 
    dplyr::summarise(quantile = quantile(!!quo(PC1),probs = 0.95)) %>% 
    pull()
fire.adults95 <- c(fire.adults95, data)
}

adult.tolerance = fire.adults95 - fire.adults

fire.seeds<- c()
for(i in seq(1,48,4)){
data<- seedling_data_pcapts %>% 
    pluck(i) %>% 
    ungroup() %>% 
    dplyr::select(!!quo(PC1)) %>% 
    dplyr::summarise(quantile = quantile(!!quo(PC1),probs = 0.05)) %>% 
    pull()
fire.seeds <- c(fire.seeds, data)
}

for(i in seq(4,48,4)){
print(names(seedling_data_pcapts)[i] == names(adult_data_pcapts)[i])
}

t.test(fire.seeds/adult.tolerance,fire.adults/adult.tolerance, paired=TRUE)

fire.diffs5 <- pc1.diffs.sep %>% 
  filter(agent == "fire") %>% 
  pull(quant_5)

t.test(fire.diffs5, altervative="two.sided", mu=0, paired=FALSE)
```

```{r,echo=FALSE, results="hide"}
#test for significant shifts from zero

#' get_pvalues
#'
#' @param pc1.diffs.sep dataframe containing the calculated differences in 5th, 50th and 95th quantiles of one climate variable or principal component for each species/agent 
#'
#' @return a dataframe with the results of a Wilcoxen Signed Rank test, testing if the difference in quantile is significantly different from 0.   
#' @export
#'
#' @examples
get_pvalues <- function(pc1.diffs.sep){
agent.list = unique(pc1.diffs.sep$agent)
quant.list = c(5, 50, 95)
pc1.p.table = data.frame()
for(i in 1:length(agent.list)){
  cat(i, "\n")
  for(j in 1:length(quant.list)){
    cat(j, "\n")
test.temp <- pc1.diffs.sep %>% 
  filter(agent == agent.list[i]) %>% 
  pull(!!paste("quant",quant.list[j],sep="_")) %>% 
  t.test(y = NULL, alternative = "two.sided", mu = 0, paired = FALSE, var.equal = FALSE, conf.level = 0.95)
    
p.temp <- test.temp$p.value
est.temp <- test.temp$estimate
lower.temp <- test.temp$conf.int[1]
upper.temp <- test.temp$conf.int[2]
p.df <- data.frame(agent = paste(agent.list[i]), quant = paste("quant",quant.list[j],sep="_"), p.value = p.temp, estimate = est.temp, lowerci = lower.temp, upperci = upper.temp)
pc1.p.table <- bind_rows(pc1.p.table, p.df)
  }
}
  return(pc1.p.table)
}

#this call to options will tell me where the warnings occur. In this case, for the comparison of medians in the fire plots and harvest plots, the exact p-value cannot be calculated because there are values that are exactly equal to 0 in the data. I think this is ok.  
options(warn = 1)
pvalues.pc1 <- get_pvalues(pc1.diffs.sep)
pvalues.pc1

#need to do Wilcoxon Signed Rank Test for 5th percentile of harvest
harvest5.test <- pc1.diffs.sep %>% 
  filter(agent == "harvest") %>% 
  pull("quant_5") %>% 
  wilcox.test(y = NULL, alternative = "two.sided", mu = 0, conf.int = TRUE, conf.level = 0.95)

harvest5.p.df <- data.frame(agent = "harvest", quant = "quant_5", p.value = harvest5.test$p.value, estimate = harvest5.test$estimate, lowerci = harvest5.test$conf.int[1], upperci = harvest5.test$conf.int[2])

##replace 5th percentile of harvest with wilcoxon test values
pvalues.pc1<- pvalues.pc1 %>% 
                rows_update(harvest5.p.df,by=c("agent","quant"))

```

The first plot here shows shifts on the 5th, 50th and 95th percentiles for all species combined, with individual species shifts plotted as dots. The second plot is the result of a Wilcoxon Signed Rank test (non-parametric t-test), showing the estimate as a diamond and the 95% confidence interval as lines. Asterisks indicate whether the shift was significantly different from zero (p\<0.05).

```{r, echo=FALSE}
#make data long for plotting
pc1.diffs.long <- pc1.diffs.sep %>% 
  pivot_longer(cols = c(quant_5, quant_50, quant_95), names_to = "quant", values_to = "diff")

ggplot(pc1.diffs.long, aes(x=agent, y=diff))+
  geom_boxplot(fill="lightgrey")+
  geom_jitter(height=0,width=0.2, aes(color=species.name))+
  facet_wrap(~quant)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##dataframe for stars
pvalues.pc1<- pvalues.pc1 %>% 
  mutate(sym.pos = ifelse(p.value<0.05,0.15,NA))

quant.labs = c("5th quantile","50th quantile","95th quantile") 
names(quant.labs)= c("quant_5","quant_50","quant_95")

ggplot(pvalues.pc1, aes(x=agent, y=estimate, color = quant, fill=quant))+
  geom_point(shape = 23, size = 3.5)+
  geom_errorbar(aes(ymin=lowerci, ymax=upperci),width=0.3, size=1)+
  scale_color_manual(values = c("#d7191c", "#fdae61","#2b83ba"))+
  scale_fill_manual(values = c("#d7191c", "#fdae61","#2b83ba"))+
  geom_text(data = subset(pvalues.pc1, !is.na(sym.pos)), aes(x=agent, y=sym.pos), label="*", color="black")+
  geom_hline(yintercept=0, color="black", lty=2, size=1)+
facet_wrap(~ quant, labeller = labeller(quant=quant.labs))+
  ggtitle("Shifts on PC1")+
  ylab("Difference on PC1")+
  xlab("")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust = 1), axis.text = element_text(size=12, color="black"), text = element_text(size=12),legend.text = element_text(size=12),strip.text = element_text(color="black",size=12), legend.position = "none")

theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))
```

Here I test for significant differences among disturbance agents in adult vs. seedling differences in the three percentiles of PC1. There are no significant differences between disturbances in shifts on PC1.

```{r, echo=FALSE}
library(car)
#check for significant differences in 5th percentile by disturbance type
pc1.mod5 <- lm(quant_5 ~ agent, data=pc1.diffs.sep)
qqPlot(pc1.mod5)
leveneTest(quant_5 ~ agent, data=pc1.diffs.sep)
anova(pc1.mod5)
#check for significant differences in 50th percentile by disturbance type
pc1.mod50 <- lm(quant_50 ~ agent, data=pc1.diffs.sep)
qqPlot(pc1.mod50)
leveneTest(quant_50 ~ agent, data=pc1.diffs.sep)
anova(pc1.mod50)
#check for significant differences in 95th percentile by disturbance type
pc1.mod95 <- lm(quant_95 ~ agent, data=pc1.diffs.sep)
qqPlot(pc1.mod95)
leveneTest(quant_95 ~ agent, data=pc1.diffs.sep)
anova(pc1.mod95)
```

###PC2

And now for PC2, which corresponds most strongly to precipitation variables, with negative shifts representing seedling shifts to wetter climates and positive shifts representing seedling shifts to drier climates.

```{r, echo=FALSE, results='hide'}
#calculate difference in 5th, 50th and 95th percentiles in pc2 position between adults and seedlings of each species and disturbance type 
pc2.diffs.table <- data.frame(uid = names(adult_data_pcapts))
for(i in c(0.05, 0.5, 0.95)){
diffs <- get_diff(adult_data_pcapts, seedling_data_pcapts, quo(PC2), i) 
  pc2.diffs.table <- pc2.diffs.table %>% 
    left_join(diffs, by = "uid")
}
pc2.diffs.table

#get dataframe in order for analysis and plotting
pc2.diffs.sep <- pc2.diffs.table %>% 
  separate(uid, c("species","agent"),sep="_",remove=FALSE, extra="drop") %>% 
  mutate(species = as.numeric(species)) %>% 
  left_join(species.names,by=c("species" = "species.code"))
```

```{r,echo=FALSE,eval=FALSE, results='hide'}
##checking for normality
fire.diffs.pc2<- pc2.diffs.sep %>% 
  filter(agent == "fire")
harvest.diffs.pc2<- pc2.diffs.sep %>% 
  filter(agent == "harvest")
id.diffs.pc2<- pc2.diffs.sep %>% 
  filter(agent == "insect.disease")
none.diffs.pc2<- pc2.diffs.sep %>% 
  filter(agent == "none")

#fire 5th quantile
ggqqplot(fire.diffs.pc2$quant_5)
ggqqplot(fire.diffs.pc2$quant_5)
shapiro.test(fire.diffs.pc2$quant_5)

#fire 50th quantile -- NOT NORMAL
ggqqplot(fire.diffs.pc2$quant_50)
ggqqplot(fire.diffs.pc2$quant_50)
shapiro.test(fire.diffs.pc2$quant_50)

#fire 95th quantile
ggqqplot(fire.diffs.pc2$quant_95)
ggqqplot(fire.diffs.pc2$quant_95)
shapiro.test(fire.diffs.pc2$quant_95)

#harvest 5th quantile -- NOT NORMAL BC OF ONE OUTLIER
ggqqplot(harvest.diffs.pc2$quant_5)
ggqqplot(harvest.diffs.pc2$quant_5)
shapiro.test(harvest.diffs.pc2$quant_5)

#harvest 50th quantile
ggqqplot(harvest.diffs.pc2$quant_50)
ggqqplot(harvest.diffs.pc2$quant_50)
shapiro.test(harvest.diffs.pc2$quant_50)

#harvest 95th quantile -- NOT NORMAL
ggqqplot(harvest.diffs.pc2$quant_95)
ggqqplot(harvest.diffs.pc2$quant_95)
shapiro.test(harvest.diffs.pc2$quant_95)

#id 5th quantile
ggqqplot(id.diffs.pc2$quant_5)
ggqqplot(id.diffs.pc2$quant_5)
shapiro.test(id.diffs.pc2$quant_5)

#id 50th quantile
ggqqplot(id.diffs.pc2$quant_50)
ggqqplot(id.diffs.pc2$quant_50)
shapiro.test(id.diffs.pc2$quant_50)

#id 95th quantile -- NOT NORMAL
ggqqplot(id.diffs.pc2$quant_95)
ggqqplot(id.diffs.pc2$quant_95)
shapiro.test(id.diffs.pc2$quant_95)

#none 5th quantile
ggqqplot(none.diffs.pc2$quant_5)
ggqqplot(none.diffs.pc2$quant_5)
shapiro.test(none.diffs.pc2$quant_5)

#none 50th quantile
ggqqplot(none.diffs.pc2$quant_50)
ggqqplot(none.diffs.pc2$quant_50)
shapiro.test(none.diffs.pc2$quant_50)

#none 95th quantile
ggqqplot(none.diffs.pc2$quant_95)
ggqqplot(none.diffs.pc2$quant_95)
shapiro.test(none.diffs.pc2$quant_95)

```


```{r,echo=FALSE, results='hide'}
#perform T-tests
pvalues.pc2 <- get_pvalues(pc2.diffs.sep)
pvalues.pc2

#perform wilcoxon tests for non-normal data
# 50th fire
pc2.fire50.test <- pc2.diffs.sep %>% 
  filter(agent == "fire") %>% 
  pull("quant_50") %>% 
  wilcox.test(y = NULL, alternative = "two.sided", mu = 0, conf.int = TRUE, conf.level = 0.95)

pc2.fire50.p.df <- data.frame(agent = "fire", quant = "quant_50", p.value = pc2.fire50.test$p.value, estimate = pc2.fire50.test$estimate, lowerci = pc2.fire50.test$conf.int[1], upperci = pc2.fire50.test$conf.int[2])

#5th harvest
pc2.harvest5.test <- pc2.diffs.sep %>% 
  filter(agent == "harvest") %>% 
  pull("quant_5") %>% 
  wilcox.test(y = NULL, alternative = "two.sided", mu = 0, conf.int = TRUE, conf.level = 0.95)

pc2.harvest5.p.df <- data.frame(agent = "harvest", quant = "quant_5", p.value = pc2.harvest5.test$p.value, estimate = pc2.harvest5.test$estimate, lowerci = pc2.harvest5.test$conf.int[1], upperci = pc2.harvest5.test$conf.int[2])

#95th harvest
pc2.harvest95.test <- pc2.diffs.sep %>% 
  filter(agent == "harvest") %>% 
  pull("quant_95") %>% 
  wilcox.test(y = NULL, alternative = "two.sided", mu = 0, conf.int = TRUE, conf.level = 0.95)

pc2.harvest95.p.df <- data.frame(agent = "harvest", quant = "quant_95", p.value = pc2.harvest95.test$p.value, estimate = pc2.harvest95.test$estimate, lowerci = pc2.harvest95.test$conf.int[1], upperci = pc2.harvest95.test$conf.int[2])

#95th id
pc2.id95.test <- pc2.diffs.sep %>% 
  filter(agent == "insect.disease") %>% 
  pull("quant_95") %>% 
  wilcox.test(y = NULL, alternative = "two.sided", mu = 0, conf.int = TRUE, conf.level = 0.95)

pc2.id95.p.df <- data.frame(agent = "insect.disease", quant = "quant_95", p.value = pc2.id95.test$p.value, estimate = pc2.id95.test$estimate, lowerci = pc2.id95.test$conf.int[1], upperci = pc2.id95.test$conf.int[2])


##replace 5th percentile of harvest with wilcoxon test values
pvalues.pc2<- pvalues.pc2 %>% 
                rows_update(pc2.harvest5.p.df, by=c("agent","quant")) %>% 
                rows_update(pc2.fire50.p.df, by=c("agent","quant")) %>% 
                rows_update(pc2.harvest95.p.df, by=c("agent","quant")) %>% 
                rows_update(pc2.id95.p.df, by=c("agent","quant"))
```

```{r, echo=FALSE}
#make data long for plotting
pc2.diffs.long <- pc2.diffs.sep %>% 
  pivot_longer(cols = c(quant_5, quant_50, quant_95), names_to = "quant", values_to = "diff")

ggplot(pc2.diffs.long, aes(x=agent, y=diff))+
  geom_boxplot(fill="lightgrey")+
  geom_jitter(height=0,width=0.2, aes(color=species.name))+
  facet_wrap(~quant)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1))

##dataframe for stars
pvalues.pc2<- pvalues.pc2 %>% 
  mutate(sym.pos = ifelse(p.value<0.05,0.15,NA))

ggplot(pvalues.pc2, aes(x=agent, y=estimate, color = quant, fill=quant))+
  geom_point(shape = 23, size = 3.5)+
  geom_errorbar(aes(ymin=lowerci, ymax=upperci),width=0.3, size=1)+
  scale_color_manual(values = c("turquoise", "#fdae61","tan4"))+
  scale_fill_manual(values = c("turquoise", "#fdae61","tan4"))+
  geom_text(data = subset(pvalues.pc2, !is.na(sym.pos)), aes(x=agent, y=sym.pos), label="*", color="black")+
  geom_hline(yintercept=0, color="black", size=1, lty=2)+
facet_wrap(~ quant, labeller= labeller(quant=quant.labs))+
  ggtitle("Shifts on PC2")+
  xlab("")+
  ylab("Difference on PC2")+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust = 1), axis.text = element_text(color="black",size=12), text = element_text(color="black",size=12), strip.text = element_text(color="black",size=12), legend.position = "none")
```

The only significant difference between disturbances in shifts on PC2 was for shifts of the 95th quantile. The shift in the 95th percentile of PC2 was  significant with a p-value of 0.03. Looking at the boxplot, we see that this marginal significance is likely due to insect disease causing greater positive shifts in the 5th percentile of PC2 than the other disturbances. When running a Tukey HSD test on it, the shift in insect/disease plots is significantly different from the fire and the undisturbed plots, but not from the harvested plots.

```{r, echo=FALSE, results='hide'}
#calculate difference in 5th, 50th and 95th percentiles in pc2 position between adults and seedlings of each species and disturbance type 
pc2.diffs.table <- data.frame(uid = names(adult_data_pcapts))
for(i in c(0.05, 0.5, 0.95)){
diffs <- get_diff(adult_data_pcapts, seedling_data_pcapts, quo(PC2), i) 
  pc2.diffs.table <- pc2.diffs.table %>% 
    left_join(diffs, by = "uid")
}
pc2.diffs.table
```

```{r, echo=FALSE}
#test for significant differences in the quantiles
pc2.diffs.sep <- pc2.diffs.table %>% 
  separate(uid, c("species","agent"),sep="_",remove=FALSE, extra="drop") %>% 
  mutate(species = as.numeric(species)) %>% 
  left_join(species.names,by=c("species" = "species.code"))

#check for significant differences in 5th percentile by disturbance type
pc2.mod5 <- lm(quant_5 ~ agent, data=pc2.diffs.sep)
qqPlot(pc2.mod5)
leveneTest(quant_5 ~ agent, data=pc2.diffs.sep)
anova(pc2.mod5)
summary(pc2.mod5)

#check for significant differences in 50th percentile by disturbance type
pc2.mod50 <- lm(quant_50 ~ agent, data=pc2.diffs.sep)
par(mfrow=c(1,1))
qqPlot(pc2.mod50)
leveneTest(quant_50 ~ agent, data=pc2.diffs.sep) #I think this is ok since ANOVA F-test is robust to assumptions of equal variances and the residuals look pretty good. 
par(mfrow=c(2,2))
plot(pc2.mod50)
anova(pc2.mod50)

#check for significant differences in 95th percentile by disturbance type
pc2.mod95 <- lm(quant_95 ~ agent, data=pc2.diffs.sep)
qqPlot(pc2.mod95)
leveneTest(quant_95 ~ agent, data=pc2.diffs.sep)
anova(pc2.mod95)
TukeyHSD(aov(quant_95 ~ agent, data=pc2.diffs.sep))
```

##Species specific range shifts

First I'm just going to look at whether each species is experiencing contraction, expansion, or shift on PC1. 

```{r}
shifts.raw<- data.frame(species=character(),agent=character(), age=character(), pos.05=numeric(), pos.95=numeric())
for(i in 1:length(adult_data_pcapts)){
adult.95<- adult_data_pcapts %>% 
    pluck(names(adult_data_pcapts)[i]) %>% 
    ungroup() %>% 
    dplyr::select(PC1) %>% 
    dplyr::summarise(quantile = quantile(PC1,probs = 0.95))%>% 
    pull()
adult.05 <- adult_data_pcapts %>% 
    pluck(names(adult_data_pcapts)[i]) %>% 
    ungroup() %>% 
    dplyr::select(PC1) %>% 
    dplyr::summarise(quantile = quantile(PC1,probs = 0.05))%>% 
    pull()
seed.95<- seedling_data_pcapts %>% 
    pluck(names(seedling_data_pcapts)[i]) %>% 
    ungroup() %>% 
    dplyr::select(PC1) %>% 
    dplyr::summarise(quantile = quantile(PC1,probs = 0.95))%>% 
    pull()
seed.05 <- seedling_data_pcapts %>% 
    pluck(names(seedling_data_pcapts)[i]) %>% 
    ungroup() %>% 
    dplyr::select(PC1) %>% 
    dplyr::summarise(quantile = quantile(PC1,probs = 0.05)) %>% 
    pull()
shifts.raw <- rbind(shifts.raw,data.frame(species=rep(unique(adult_data_pcapts[[i]]$SPCD),2), agent = rep(unique(adult_data_pcapts[[i]]$Agent),2), age = c("adult", "seed"),pos.05=c(adult.05,seed.05), pos.95 = c(adult.95,seed.95)))
}

shifts.raw<- shifts.raw %>% 
  left_join(species.names, by=c(species="species.code"))

ggplot(shifts.raw)+
  geom_errorbar(aes(x= agent, ymin=pos.05, ymax=pos.95, color=age, width=0.3), size=1.5, position = "dodge")+
  facet_wrap(~species.name)+
  scale_color_manual(values=c("black","green"))


```


The one species-specific test we can do, is a t-test comparing the mean positions on PC1 and PC2 of seedlings vs. adults in different disturbance types.

###PC1

First, PC1:

```{r, echo=FALSE, results='hide'}
##check for normality PC1
#grab multiplot function script
source("multiplot_fxn.R")

##adult
adultplots = list()
for(i in 1:48){
group <- adult_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  pull(PC1) 
adultplots[[i]]<- group
}

plotlist<- list()
for(i in 1:48){
  plot<- ggdensity(adultplots[[i]])
  plotlist[[i]]<- plot
}
qplotlist<- list()
for(i in 1:48){
  plot<- ggqqplot(adultplots[[i]])
  qplotlist[[i]]<- plot
}

##seedling
seedlingplots = list()
for(i in 1:48){
group <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  pull(PC1) 
seedlingplots[[i]]<- group
}

splotlist<- list()
for(i in 1:48){
  plot<- ggdensity(seedlingplots[[i]])
  splotlist[[i]]<- plot
}
sqplotlist<- list()
for(i in 1:48){
  plot<- ggqqplot(seedlingplots[[i]])
  sqplotlist[[i]]<- plot
}


vartest.results<-data.frame()
for(i in 1:48){
vartest<- var.test(seedlingplots[[i]],adultplots[[i]],alternative="two.sided")
vartest.results<-rbind(vartest.results, data.frame(num=i, p=vartest$p.value))
}   

```

```{r, echo=FALSE, eval=FALSE}
#plot tests of normality on PC1 
#adult
multiplot(plotlist=plotlist,cols=6)
multiplot(plotlist=qplotlist,cols=6)

#seedling
multiplot(plotlist=splotlist,cols=6)
multiplot(plotlist=sqplotlist,cols=6)
```

```{r, echo=FALSE, results="hide"}
#do the t-tests for PC1
pc1.ttest.pvalues <- data.frame()
for(i in 1:length(adult_data_pcapts)){
temp.adult <- adult_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC1)

temp.seed <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC1)

temp.test<- t.test(temp.adult, temp.seed, paired=FALSE, var.equal = TRUE, conf.level=0.95)
pc1.ttest.pvalues <- bind_rows(pc1.ttest.pvalues, data.frame(uid = names(adult_data_pcapts)[i], diff.means = temp.test$estimate[2] - temp.test$estimate[1],p.value = temp.test$p.value))
}

#unequal variance t-test for some species
pc1.unequal.var <- vartest.results %>% 
                      filter(p<0.05)

pc1.ttest.pvalues.alt <- data.frame()
for(i in pc1.unequal.var$num){
temp.adult <- adult_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC1)

temp.seed <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC1)

temp.test<- t.test(temp.adult, temp.seed, paired=FALSE, var.equal = FALSE, conf.level=0.95)
pc1.ttest.pvalues.alt <- bind_rows(pc1.ttest.pvalues.alt, data.frame(uid = names(adult_data_pcapts)[i], diff.means = temp.test$estimate[2] - temp.test$estimate[1],p.value = temp.test$p.value))
}
pc1.ttest.pvalues.alt
##replace rows with unequal variance results
pc1.ttest.pvalues<- pc1.ttest.pvalues %>% 
                rows_update(pc1.ttest.pvalues.alt, by="uid")
pc1.ttest.pvalues

#get dataframe in order
pc1.ttest.pvalues
pc1.ttest.pvalues.sep <- pc1.ttest.pvalues %>% 
  separate(uid, c("species","agent"),sep="_",extra="drop",remove = FALSE) %>% 
  mutate(species = as.numeric(species)) %>% 
  left_join(species.names, by = c("species" = "species.code")) %>%   mutate(sym.pos = ifelse(p.value<0.05, 0.3, NA))
```

This plot shows the difference in seedling vs. adult positions on PC1 (seedling mean - adult mean), separated by species and disturbance type. Differences in means greater than zero indicate that seedlings occupy higher values on PC1 (cooler climates) than adults whereas negative differnces in means indicate that seedlings occupy lower values on PC1 (warmer climates) than adults. Asterisks indicate that seedling and adult positions on PC1 are significantly different (p\<0.05), as evaluated with a T-test.

```{r,echo=FALSE}
ggplot(pc1.ttest.pvalues.sep, aes(x = agent, y = diff.means, fill = agent))+
  geom_col()+
  geom_text(data = subset(pc1.ttest.pvalues.sep, !is.na(sym.pos)), aes(x=agent, y=sym.pos), label="*", color="black")+
  facet_wrap(~species.name)+
  ylim(c(-0.2,0.4))+
  ggtitle("Shifts on PC1")+
  xlab("")+
  ylab("Difference in Mean")+
  labs(fill = "Disturbance Agent")+
  theme_bw()+
  theme(axis.text.x = element_blank(), axis.text=element_text(color="black", size=12), legend.text = element_text(color="black", size=12), text=element_text(color="black", size=12), strip.text = element_text(color="black", size=11))
```

###PC2

Now for PC2, where postive differences mean that seedlings occupied higher values on PC2 (drier climates) than adults, and negative differences mean that seedlings occupied lower values on PC2 (wetter climates).

```{r, echo=FALSE, results='hide'}
##check for normality on PC2

##adults
pc2_adultplots = list()
for(i in 1:48){
group <- adult_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  pull(PC2) 
pc2_adultplots[[i]]<- group
}

pc2_plotlist<- list()
for(i in 1:48){
  plot<- ggdensity(pc2_adultplots[[i]])
  pc2_plotlist[[i]]<- plot
}
pc2_qplotlist<- list()
for(i in 1:48){
  plot<- ggqqplot(pc2_adultplots[[i]])
  pc2_qplotlist[[i]]<- plot
}

##seedlings
pc2_seedlingplots = list()
for(i in 1:48){
group <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  pull(PC2) 
pc2_seedlingplots[[i]]<- group
}

pc2_splotlist<- list()
for(i in 1:48){
  plot<- ggdensity(pc2_seedlingplots[[i]])
  pc2_splotlist[[i]]<- plot
}
pc2_sqplotlist<- list()
for(i in 1:48){
  plot<- ggqqplot(pc2_seedlingplots[[i]])
  pc2_sqplotlist[[i]]<- plot
}

##test for equal variance. p<0.05 indicates unequal variance
pc2_vartest.results<-data.frame()
for(i in 1:48){
vartest<- var.test(pc2_seedlingplots[[i]],pc2_adultplots[[i]],alternative="two.sided")
pc2_vartest.results<-rbind(pc2_vartest.results, data.frame(num=i, p=vartest$p.value))
}   
pc2_vartest.results %>% 
  filter(p<0.05)
```

```{r, eval=FALSE, echo=FALSE}
#plot checks for normality PC2
##adults
multiplot(plotlist=pc2_plotlist,cols=6)
multiplot(plotlist=pc2_qplotlist,cols=6)
##seedlings
multiplot(plotlist=pc2_splotlist,cols=6)
multiplot(plotlist=pc2_sqplotlist,cols=6)
```


```{r, echo=FALSE, results='hide'}
#do the t-test with assumption of equal vars PC2
pc2.ttest.pvalues <- data.frame()
for(i in 1:length(adult_data_pcapts)){
temp.adult <- adult_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC2)

temp.seed <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC2)

temp.test<- t.test(temp.adult, temp.seed, paired=FALSE, var.equal = TRUE, conf.level=0.95)
pc2.ttest.pvalues <- bind_rows(pc2.ttest.pvalues, data.frame(uid = names(adult_data_pcapts)[i], diff.means = temp.test$estimate[2] - temp.test$estimate[1],p.value = temp.test$p.value))

}

#unequal variance t-test for some species/disturbances for PC2
pc2.unequal.var <- pc2_vartest.results %>% 
                      filter(p<0.05)

pc2.ttest.pvalues.alt <- data.frame()
for(i in pc2.unequal.var$num){
temp.adult <- adult_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC2)

temp.seed <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  ungroup() %>% 
  dplyr::select(PC2)

temp.test<- t.test(temp.adult, temp.seed, paired=FALSE, var.equal = FALSE, conf.level=0.95)
pc2.ttest.pvalues.alt <- bind_rows(pc2.ttest.pvalues.alt, data.frame(uid = names(adult_data_pcapts)[i], diff.means = temp.test$estimate[2] - temp.test$estimate[1],p.value = temp.test$p.value))
}
pc2.ttest.pvalues.alt
##replace rows with unequal variance results
pc2.ttest.pvalues<- pc2.ttest.pvalues %>% 
                rows_update(pc2.ttest.pvalues.alt, by="uid")
pc2.ttest.pvalues

#get data in order
pc2.ttest.pvalues
pc2.ttest.pvalues.sep <- pc2.ttest.pvalues %>% 
  separate(uid, c("species","agent"),sep="_",extra="drop",remove = FALSE) %>% 
  mutate(species = as.numeric(species)) %>% 
  left_join(species.names, by = c("species" = "species.code")) %>%   mutate(sym.pos = ifelse(p.value<0.05, 0.3, NA))
```

```{r, echo=FALSE}
ggplot(pc2.ttest.pvalues.sep, aes(x = agent, y = diff.means, fill = agent))+
  geom_col()+
  geom_text(data = subset(pc2.ttest.pvalues.sep, !is.na(sym.pos)), aes(x=agent, y=sym.pos), label="*", color="black")+
  facet_wrap(~species.name)+
  ylim(c(-0.2,0.4))+
  ggtitle("Shifts on PC2")+
  xlab("")+
  ylab("Difference in Mean")+
  labs(fill = "Disturbance Agent")+
  theme_bw()+
  theme(axis.text.x = element_blank(), axis.text=element_text(color="black",size=12), text=element_text(color="black",size=12), legend.text = element_text(color="black",size=12), strip.text = element_text(color="black",size=11))
```

###Climate Niches

Now I will plot the climate "niche" of each species for each disturbance type in the two dimensional PCA space to visualize the niche shifts.

```{r, echo=FALSE, results='hide'}
#unlisting pcapts lists
adult_pca_unlist<- ldply(adult_data_pcapts, .id = "uid")
seedling_pca_unlist<- ldply(seedling_data_pcapts, .id="uid")

colnames(adult_pca_unlist) == colnames(seedling_pca_unlist)

comb_pcapts<- bind_rows(list(adult = adult_pca_unlist, seedling = seedling_pca_unlist), .id = "age")
```

```{r, echo=FALSE, eval=FALSE}
#plot climate niches of adults vs. seedlings of species in PCA space
plot_niche <- function(agent, species, name, color) {
  ggplot()+
    xlim(c(min(clim_pca$x[,1]),max(clim_pca$x[,1])))+
    ylim(c(min(clim_pca$x[,2]),max(clim_pca$x[,2])))+
      geom_point(data=comb_pcapts %>% 
                   filter(Agent == agent, SPCD == species),
                 aes(x=PC1, y=PC2, color=age),size=1)+
    stat_ellipse(data=comb_pcapts %>% 
                   filter(Agent == agent, SPCD == species),
                 aes(x=PC1, y=PC2, color=age),type="norm",level=0.95,cex=1.3)+
    scale_color_manual(values=c("#000000",color))+
    ggtitle(paste(name,agent,sep="-"))+
    theme_bw()+
    theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11))
}

x11()
plot_niche("fire","106","Pinyon", "#F8766D")
gglocator()
plot_niche("none", "106", "Pinyon", "#C77CFF")

plot_niche("none","108","Lodgepole pine","#C77CFF")
plot_niche("harvest", "108", "Lodgepole pine", "#7CAE00")
plot_niche("insect.disease","108","Lodgepole pine","#00BFC4")

##check for appropriate distribution for ellipse
#lodgepole adults undisturbed
adult.108.none.pc1<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="108", Agent==
           "none") %>% 
  pull(PC1)
adult.108.none.pc2<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="108", Agent==
           "none") %>% 
  pull(PC2)
descdist(adult.108.none.pc1, discrete = FALSE)
descdist(adult.108.none.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(adult.108.none.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(adult.108.none.pc2, "norm")
fit.t.pc2 <- fitdist(adult.108.none.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.norm.pc2)
plot(fit.t.pc2)
#lodgepole seedlings undisturbed
seed.108.none.pc1<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="108", Agent==
           "none") %>% 
  pull(PC1)
seed.108.none.pc2<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="108", Agent==
           "none") %>% 
  pull(PC2)
descdist(seed.108.none.pc1, discrete = FALSE)
descdist(seed.108.none.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(seed.108.none.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(seed.108.none.pc2, "norm")
fit.t.pc2 <- fitdist(seed.108.none.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.t.pc2)
plot(fit.norm.pc2)
#lodgepole adults harvest
adult.108.harvest.pc1<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="108", Agent==
           "harvest") %>% 
  pull(PC1)
adult.108.harvest.pc2<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="108", Agent==
           "harvest") %>% 
  pull(PC2)
descdist(adult.108.harvest.pc1, discrete = FALSE)
descdist(adult.108.harvest.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(adult.108.harvest.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(adult.108.harvest.pc2, "norm")
fit.t.pc2 <- fitdist(adult.108.harvest.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.norm.pc2)
plot(fit.t.pc2)
#lodgepole seedlings harvest
seed.108.harvest.pc1<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="108", Agent==
           "harvest") %>% 
  pull(PC1)
seed.108.harvest.pc2<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="108", Agent==
           "harvest") %>% 
  pull(PC2)
descdist(seed.108.harvest.pc1, discrete = FALSE)
descdist(seed.108.harvest.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(seed.108.harvest.pc1, "norm")
fit.log.pc1<- fitdist(seed.108.harvest.pc1, "logis")
plot(fit.norm.pc1)
plot(fit.log.pc1)
fit.norm.pc2 <- fitdist(seed.108.harvest.pc2, "norm")
fit.t.pc2 <- fitdist(seed.108.harvest.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
fit.log.pc2<- fitdist(seed.108.harvest.pc2, "logis")
plot(fit.t.pc2)
plot(fit.norm.pc2)
plot(fit.log.pc2)
#lodgepole adults ID
adult.108.insect.disease.pc1<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="108", Agent==
           "insect.disease") %>% 
  pull(PC1)
adult.108.insect.disease.pc2<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="108", Agent==
           "insect.disease") %>% 
  pull(PC2)
descdist(adult.108.insect.disease.pc1, discrete = FALSE)
descdist(adult.108.insect.disease.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(adult.108.insect.disease.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(adult.108.insect.disease.pc2, "norm")
fit.t.pc2 <- fitdist(adult.108.insect.disease.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.norm.pc2)
plot(fit.t.pc2)
#lodgepole seedlings ID
seed.108.insect.disease.pc1<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="108", Agent==
           "insect.disease") %>% 
  pull(PC1)
seed.108.insect.disease.pc2<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="108", Agent==
           "insect.disease") %>% 
  pull(PC2)
descdist(seed.108.insect.disease.pc1, discrete = FALSE)
descdist(seed.108.insect.disease.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(seed.108.insect.disease.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(seed.108.insect.disease.pc2, "norm")
fit.t.pc2 <- fitdist(seed.108.insect.disease.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.t.pc2)
plot(fit.norm.pc2)

##aspen
#aspen adults none
adult.746.none.pc1<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="746", Agent==
           "none") %>% 
  pull(PC1)
adult.746.none.pc2<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="746", Agent==
           "none") %>% 
  pull(PC2)
descdist(adult.746.none.pc1, discrete = FALSE)
descdist(adult.746.none.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(adult.746.none.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(adult.746.none.pc2, "norm")
fit.t.pc2 <- fitdist(adult.746.none.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.norm.pc2)
plot(fit.t.pc2)
#aspen seedlings none
seed.746.none.pc1<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="746", Agent==
           "none") %>% 
  pull(PC1)
seed.746.none.pc2<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="746", Agent==
           "none") %>% 
  pull(PC2)
descdist(seed.746.none.pc1, discrete = FALSE)
descdist(seed.746.none.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(seed.746.none.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(seed.746.none.pc2, "norm")
fit.t.pc2 <- fitdist(seed.746.none.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.t.pc2)
plot(fit.norm.pc2)
#aspen adults fire
adult.746.fire.pc1<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="746", Agent==
           "fire") %>% 
  pull(PC1)
adult.746.fire.pc2<- comb_pcapts %>% 
  filter(age=="adult", SPCD=="746", Agent==
           "fire") %>% 
  pull(PC2)
descdist(adult.746.fire.pc1, discrete = FALSE)
descdist(adult.746.fire.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(adult.746.fire.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(adult.746.fire.pc2, "norm")
fit.t.pc2 <- fitdist(adult.746.fire.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.norm.pc2)
plot(fit.t.pc2)
#aspen seedlings fire
seed.746.fire.pc1<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="746", Agent==
           "fire") %>% 
  pull(PC1)
seed.746.fire.pc2<- comb_pcapts %>% 
  filter(age=="seedling", SPCD=="746", Agent==
           "fire") %>% 
  pull(PC2)
descdist(seed.746.fire.pc1, discrete = FALSE)
descdist(seed.746.fire.pc2, discrete=FALSE)
fit.norm.pc1 <- fitdist(seed.746.fire.pc1, "norm")
plot(fit.norm.pc1)
fit.norm.pc2 <- fitdist(seed.746.fire.pc2, "norm")
fit.t.pc2 <- fitdist(seed.746.fire.pc2, "t",start = list(df=3), lower = c(-1,0.001,1))
plot(fit.t.pc2)
plot(fit.norm.pc2)
###CAN USE NORMAL ELLIPSES

plot_niche("none","63","Alligator juniper", "#C77CFF")

plot_niche("fire","202","Douglas fir","#F8766D")
plot_niche("insect.disease","202","Douglas fir","#00BFC4")

plot_niche("insect.disease", "814", "Gambel oak", "#00BFC4")

plot_niche("fire", "19", "subalpine fir", "#F8766D")
plot_niche("none", "19", "subalpine fir", "#C77CFF")

plot_niche("fire", "746", "aspen", "#F8766D")
plot_niche("none", "746", "aspen", "#C77CFF")

plot_niche("insect.disease","15","white fir","#00BFC4")

plot_niche("insect.disease", "93", "Engelmann spruce","#00BFC4")
plot_niche("none", "93", "Engelmann spruce","#C77CFF")

##example plots for ESA talk
#adult plot
pc1.mean.adult<- mean(comb_pcapts %>% 
                   filter(Agent == "fire", SPCD == "202",age=="adult") %>% 
                     dplyr::pull("PC1"))
pc2.mean.adult<- mean(comb_pcapts %>% 
                   filter(Agent == "fire", SPCD == "202",age=="adult") %>% 
                     dplyr::pull("PC2"))

ggplot()+
    xlim(c(min(clim_pca$x[,1]),max(clim_pca$x[,1])))+
    ylim(c(min(clim_pca$x[,2]),max(clim_pca$x[,2])))+
      geom_point(data=comb_pcapts %>% 
                   filter(Agent == "fire", SPCD == "202",age=="adult"), aes(x=PC1, y=PC2,color=age),size=1)+
#  geom_vline(xintercept=quantile(comb_pcapts %>% 
#                   filter(Agent == "fire", SPCD == #"202",age=="adult") %>% 
#                     dplyr::pull("PC1"),c(0.05,0.5,0.95)),linetype=2,color="blue")+
#  geom_hline(yintercept=quantile(comb_pcapts %>% 
#                   filter(Agent == "fire", SPCD == #"202",age=="adult") %>% 
#                     dplyr::pull("PC2"),c(0.05,0.5,0.95)),linetype=2,color="red")+
    scale_color_manual(values=c("#000000"))+
  geom_point(aes(x=pc1.mean.seed,y=pc2.mean.seed),shape=23,size=5,color="black",fill="#F8766D")+
    theme_bw()+
    theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11))

##seedling plot 
pc1.mean.seed<- mean(comb_pcapts %>% 
                   filter(Agent == "fire", SPCD == "202",age=="seedling") %>% 
                     dplyr::pull("PC1"))
pc2.mean.seed<- mean(comb_pcapts %>% 
                   filter(Agent == "fire", SPCD == "202",age=="seedling") %>% 
                     dplyr::pull("PC2"))

ggplot()+
    xlim(c(min(clim_pca$x[,1]),max(clim_pca$x[,1])))+
    ylim(c(min(clim_pca$x[,2]),max(clim_pca$x[,2])))+
      geom_point(data=comb_pcapts %>% 
                   filter(Agent == "fire", SPCD == "202",age=="seedling"),
                 aes(x=PC1, y=PC2, color=age),size=1)+
#  geom_vline(xintercept=quantile(comb_pcapts %>% 
#                   filter(Agent == "fire", SPCD == #"202",age=="seedling") %>% 
#                     dplyr::pull("PC1"),c(0.05,0.5,0.95)),linetype=2,color="blue")+
#  geom_hline(yintercept=quantile(comb_pcapts %>% 
#                   filter(Agent == "fire", SPCD == #"202",age=="seedling") %>% 
#                     dplyr::pull("PC2"),c(0.05,0.5,0.95)),linetype=2,color="red")+
    scale_color_manual(values=c("#F8766D"))+
  geom_point(aes(x=pc1.mean.seed,y=pc2.mean.seed),shape=23,size=5,color="black",fill="black")+
    theme_bw()+
    theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11))

```

```{r}
#plot niches in parabola form for ESA presentation
ggdensity(comb_pcapts %>% 
       filter(uid=="108_none_cvars") %>% 
       dplyr::select(age, CMD), x= "CMD", color="age")

adult.fake <- rbeta(100000, 5,5)
seedling.fake<- rbeta(100000, 4,5)
fake.data<- data.frame(age=c(rep("adult",length(adult.fake)),rep("seedling",length(seedling.fake))),temperature=c(adult.fake,seedling.fake))

ggdensity(fake.data, x="temperature", color="age")

curve(dbeta(x,8,4),xlim=c(0,1))
curve(dbeta(x,4,8),xlim=c(0,1))
```

an aside...
```{r, echo=FALSE, eval=FALSE}
#investigating pinyon hot plots
pinyon_hotplots<- seedling_pca_unlist %>% 
      filter(Agent == "fire",
              SPCD == 106,
              PC1 < -0.9, 
              PC2 > -1) %>% 
  left_join(plot, by=c("PLT_CN" = "CN"),keep=FALSE)

pinyon_fireplots<- seedling_pca_unlist %>% 
       filter(Agent == "fire",
              SPCD == 106) %>% 
  left_join(plot, by=c("PLT_CN" = "CN"),keep=FALSE)

usa<- map_data("state")

ggplot()+
  geom_polygon(data=usa,aes(x=long, y=lat, group=group),
                color="black", fill="lightblue")+
  geom_point(data=pinyon_fireplots, aes(x=LON, y=LAT))+
  geom_point(data=pinyon_hotplots, aes(x=LON, y=LAT),color="red")+
  coord_quickmap()
```


##Species traits effects on range shifts

###PC1

Now I will look at the effect of species traits on the magnitude of range shifts observed. First I will plot the relationships for shifts on PC1.

```{r, echo=FALSE, message=FALSE, results='hide'}
#make shade tolerance dataframe
shade.tolerance <- c(4.33, 4.01,4.83, 2, 4.53, 1.44, 1.48,1.64,2.78,4.73, 1.21,2.09)

#make drought tolerance dataframe
drought.tolerance <- c(1.91, 2.33,2.02,5,2.58,4.97, 4.21, 4.32, 2.62,2.23, 1.77, 4.97)

#read in seed weight data
seed.weight <- read_csv("C:/Users/Katie/Google Drive/FIA project/TRY data/TRY_seed_edited.csv")

try.names <- data.frame(scientific.name = unique(seed.weight$AccSpeciesName), species.code = c(15,17,19,63,93,108,106,122,746,202,814,242))

seed.weight.filter <- seed.weight %>%
  filter(is.na(OrigObsDataID)) %>% 
  filter(ErrorRisk < 4) %>% 
  distinct(ObservationID, .keep_all = TRUE) %>% 
  left_join(try.names, by=c("AccSpeciesName" = "scientific.name"))

nrow(seed.weight.filter)
length(unique(seed.weight.filter$ObservationID))

seed.weight.summary <- seed.weight.filter %>% 
  group_by(species.code) %>% 
  dplyr::summarise(mean.weight.mg = mean(StdValue))

seed.weight.filter %>% 
  group_by(species.code) %>% 
  dplyr::summarise(n=n())

#combine
trait.data<- data.frame(species.names,shade.tolerance = shade.tolerance, drought.tolerance= drought.tolerance) %>% 
  left_join(seed.weight.summary, by="species.code")

##add trait data to diffs dataframe
pc1.diffs.traits <- pc1.diffs.sep %>% 
  left_join(trait.data, by="species.name")
pc2.diffs.traits <- pc2.diffs.sep %>% 
  left_join(trait.data, by="species.name")
```

The below plot shows the relationship between absolute value of shifts on PC1 in 5th, 50th, and 95th quantiles vs. the shade tolerance of species, using values in Niinemets & Valladares (2006).

```{r, echo=FALSE}
#plot relationships
library(RColorBrewer)
####shade tolerance
shade5 <- ggplot(pc1.diffs.traits, aes(x=shade.tolerance, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

shade50 <- ggplot(pc1.diffs.traits, aes(x=shade.tolerance, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  #facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

shade95 <- ggplot(pc1.diffs.traits, aes(x=shade.tolerance, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 95th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))


ggarrange(shade5, shade50, shade95, nrow=1, ncol=3, common.legend = TRUE)
```

The next plot shows the relationship between absolute value of shifts on PC1 in 5th, 50th, and 95th quantiles vs. the drought tolerance of species, using values in Niinemets & Valladares (2006).

```{r}

qplot(drought.tolerance, abs(quant_5), shape = agent, color = agent, data = pc1.diffs.traits) +
 geom_smooth(method = "lm", se = FALSE, fullrange = T)

####drought tolerance
drought5 <- ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

drought50 <- ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

drought95 <- ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  ggtitle("PC1 95th quantile")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

ggarrange(drought5, drought50, drought95, nrow=1, ncol=3, common.legend = TRUE)

drought5a <- ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3,aes(shape=agent))+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

drought50a <- ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3,aes(shape=agent))+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

drought95a <- ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3,aes(shape=agent))+
  scale_color_brewer(palette="Paired")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  ggtitle("PC1 95th quantile")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

ggarrange(drought5a,drought50a,drought95a,ncol=3,nrow=1,common.legend = TRUE)
```

The below plot shows the relationship between shifts on PC1 in 5th, 50th, and 95th quantiles vs. the seed weight of species, using average values of results from a TRY database search. Gambel oak and pinyon were excluded from this analysis, as they were large outliers in seed weight (very heavy). Perhaps there is a better proxy for seed dispersal? Or I can scale values so that these species can be included? Even with scaling, these are large outliers. 

```{r}

####seed weight
##excluded gambel oak and pinyon as they were large outliers
weight5 <- ggplot(pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

weight50 <- ggplot(pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

weight95 <- ggplot(pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 95th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

ggarrange(weight5, weight50, weight95, nrow=1, ncol=3, common.legend = TRUE)

####seed weight
##excluded gambel oak and pinyon as they were large outliers
weight5a <- ggplot(pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3,aes(shape=agent))+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

weight50a <- ggplot(pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3,aes(shape=agent))+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(legend.position = "none",axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

weight95a <- ggplot(pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3,aes(shape=agent))+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 95th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

ggarrange(weight5a, weight50a, weight95a, nrow=1, ncol=3, common.legend = TRUE)

```

By running some linear models with species traits and disturbance type as predictor variables, we see that shade tolerance is a marginally significant predictor of the magnitude of 50th percentile shifts on PC1 and a significant predictor of the magnitude of 95th percentile shifts on PC1, with both being negative relationships (species with higher shade tolerance shifted less). There are no significant relationships between drought tolerance or seed weight and shifts on PC1 and no significant interactive effects between disturbance type and species traits (should this be a random effect?).

```{r}
library(emmeans)
##linear models
par(mfrow=c(2,2))
####shade tolerance
summary(lm(abs(quant_5)~shade.tolerance,pc1.diffs.traits))

pc1mod5_shade <- lm(abs(quant_5)~shade.tolerance*agent,pc1.diffs.traits)
summary(pc1mod5_shade)
anova(pc1mod5_shade)

qplot(shade.tolerance, abs(quant_5), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)
```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod5_shade)
```

```{r}
pc1mod50_shade <- lm(abs(quant_50)~shade.tolerance*agent,pc1.diffs.traits)
summary(aov(abs(quant_50)~shade.tolerance*agent, pc1.diffs.traits))
anova(pc1mod50_shade)
summary(pc1mod50_shade)
summary(lm(abs(quant_50)~shade.tolerance,pc1.diffs.traits))
```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod50_shade)
```

```{r}
pc1mod95_shade <- lm(abs(quant_95)~shade.tolerance*agent,pc1.diffs.traits)
summary(pc1mod95_shade)
anova(pc1mod95_shade)
summary(lm(abs(quant_95)~shade.tolerance,pc1.diffs.traits))
```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod95_shade)
```

```{r,echo=FALSE}
ggplot(pc1.diffs.traits, aes(x=shade.tolerance, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 95th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  scale_y_continuous(limits=c(-0.05,0.2),breaks=c(0,0.1,0.2))+
  theme(axis.text = element_text(color="black",size=10),text = element_text(size=10),legend.text = element_text(size=10),strip.text = element_text(color="black",size=10))

```


```{r}
####drought tolerance
pc1mod5_drought <- lm(abs(quant_5)~drought.tolerance*agent,pc1.diffs.traits)
summary(pc1mod5_drought)
anova(pc1mod5_drought)
summary(lm(abs(quant_5)~drought.tolerance,pc1.diffs.traits))

```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod5_drought)
```

```{r}
pc1mod50_drought <- lm(abs(quant_50)~drought.tolerance*agent,pc1.diffs.traits)
summary(pc1mod50_drought)
anova(pc1mod50_drought)
summary(lm(abs(quant_50)~drought.tolerance,pc1.diffs.traits))

```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod50_drought)
```

```{r}
pc1mod95_drought <- lm(abs(quant_95)~drought.tolerance*agent,pc1.diffs.traits)
anova(pc1mod95_drought)
summary(pc1mod95_drought)
summary(lm(abs(quant_95)~drought.tolerance,pc1.diffs.traits))


```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod95_drought)
```

```{r}
####seed weight
pc1mod5_weight <- lm(abs(quant_5)~mean.weight.mg*agent,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),])
summary(pc1mod5_weight)
anova(pc1mod5_weight)
summary(lm(abs(quant_5)~mean.weight.mg,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]))
```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod5_weight)
```

```{r}
pc1mod50_weight <- lm(abs(quant_50)~mean.weight.mg*agent,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),])
anova(pc1mod50_weight)
summary(pc1mod50_weight)
summary(lm(abs(quant_50)~mean.weight.mg,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]))
```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod50_weight)
```

```{r}
pc1mod95_weight <- lm(abs(quant_95)~mean.weight.mg*agent,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),])
anova(pc1mod95_weight)
summary(pc1mod95_weight)
summary(lm(abs(quant_95)~mean.weight.mg,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]))
```

```{r, echo=FALSE, eval=FALSE}
plot(pc1mod95_weight)
```

```{r}
#combine all traits in one model 

pc1mod5_all <- lm(abs(quant_5)~agent*(shade.tolerance + drought.tolerance),data=pc1.diffs.traits)
anova(pc1mod5_all)
summary(pc1mod5_all)

qplot(shade.tolerance, abs(quant_5), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)
qplot(drought.tolerance, abs(quant_5), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)

pc1mod50_all <- lm(abs(quant_50)~agent*(shade.tolerance + drought.tolerance),data=pc1.diffs.traits)
anova(pc1mod50_all)
summary(pc1mod50_all)
plot(pc1mod50_all)

qplot(shade.tolerance, abs(quant_50), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)
qplot(drought.tolerance, abs(quant_50), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)


pc1mod95_all <- lm(log(abs(quant_95))~agent*(shade.tolerance + drought.tolerance),data=pc1.diffs.traits)
anova(pc1mod95_all)
summary(pc1mod95_all)
plot(pc1mod95_all)

qplot(shade.tolerance, abs(quant_95), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)
qplot(drought.tolerance, abs(quant_95), shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)
```

###PC2

Now we'll analyze the relationship between species traits, disturbance, and the magnitude (absolute value) of shifts on PC2.

```{r, echo=FALSE}
#plot relationships
####shade tolerance
shade5_2 <- ggplot(pc2.diffs.traits, aes(x=shade.tolerance, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

shade50_2 <- ggplot(pc2.diffs.traits, aes(x=shade.tolerance, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

shade95_2 <- ggplot(pc2.diffs.traits, aes(x=shade.tolerance, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 95th quantile")+
  ylab("Shift Magnitude")+
  xlab("Shade Tolerance Score")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))


ggarrange(shade5_2, shade50_2, shade95_2, nrow=1, ncol=3, common.legend = TRUE)
```

```{r, echo=FALSE}
####drought tolerance
drought5_2 <- ggplot(pc2.diffs.traits, aes(x=drought.tolerance, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

drought50_2 <- ggplot(pc2.diffs.traits, aes(x=drought.tolerance, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

drought95_2 <- ggplot(pc2.diffs.traits, aes(x=drought.tolerance, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ylab("Shift Magnitude")+
  xlab("Drought Tolerance Score")+
  ggtitle("PC2 95th quantile")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

ggarrange(drought5_2, drought50_2, drought95_2, nrow=1, ncol=3, common.legend = TRUE)
```

```{r, echo=FALSE}
####seed weight
##excluded gambel oak and pinyon as they were large outliers
weight5_2 <- ggplot(pc2.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_5),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 5th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

weight50_2 <- ggplot(pc2.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_50),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 50th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  theme(legend.position = "none",axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

weight95_2 <- ggplot(pc2.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),]
, aes(x=mean.weight.mg, y=abs(quant_95),color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 95th quantile")+
  ylab("Shift Magnitude")+
  xlab("Seed Weight (mg)")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

ggarrange(weight5_2, weight50_2, weight95_2, nrow=1, ncol=3, common.legend = TRUE)
```

By running some linear models we see that seed weight, drought and shade tolerance do not seem to predict shifts on PC2 significantly for any of the disturbance categories.

```{r, echo=FALSE}
##linear models
par(mfrow=c(2,2))
####shade tolerance
pc2mod5_shade <- lm(abs(quant_5)~shade.tolerance*agent,pc2.diffs.traits)
anova(pc2mod5_shade)
summary(pc2mod5_shade)
summary(lm(abs(quant_5)~shade.tolerance,pc2.diffs.traits))
#plot(pc2mod5_shade)

pc2mod50_shade <- lm(abs(quant_50)~shade.tolerance*agent,pc2.diffs.traits)
anova(pc2mod50_shade)
summary(pc2mod50_shade)
summary(lm(abs(quant_50)~shade.tolerance,pc2.diffs.traits))
#plot(pc2mod50_shade)

pc2mod95_shade <- lm(abs(quant_95)~shade.tolerance*agent,pc2.diffs.traits)
anova(pc2mod95_shade)
summary(pc2mod95_shade)
summary(lm(abs(quant_95)~shade.tolerance,pc2.diffs.traits))
#plot(pc2mod95_shade)

####drought tolerance
pc2mod5_drought <- lm(abs(quant_5)~drought.tolerance*agent,pc2.diffs.traits)
anova(pc2mod5_drought)
summary(pc2mod5_drought)
summary(lm(abs(quant_5)~drought.tolerance,pc2.diffs.traits))
#plot(pc2mod5_drought)

pc2mod50_drought <- lm(abs(quant_50)~drought.tolerance*agent,pc2.diffs.traits)
anova(pc2mod50_drought)
summary(pc2mod50_drought)
summary(lm(abs(quant_50)~drought.tolerance,pc2.diffs.traits))
#plot(pc2mod50_drought)

pc2mod95_drought <- lm(abs(quant_95)~drought.tolerance*agent,pc2.diffs.traits)
anova(pc2mod95_drought)
summary(pc2mod95_drought)
summary(lm(abs(quant_95)~drought.tolerance,pc2.diffs.traits))
#plot(pc2mod95_drought)

####seed weight
pc2mod5_weight <- lm(abs(quant_5)~mean.weight.mg*agent,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),])
summary(pc2mod5_weight)
summary(lm(abs(quant_5)~mean.weight.mg,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),]))
#plot(pc2mod5_weight)

pc2mod50_weight <- lm(abs(quant_50)~mean.weight.mg*agent,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),])
summary(pc2mod50_weight)
summary(lm(abs(quant_50)~mean.weight.mg,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),]))
#plot(pc2mod50_weight)

pc2mod95_weight <- lm(abs(quant_95)~mean.weight.mg*agent,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),])
summary(pc2mod95_weight)
summary(lm(abs(quant_95)~mean.weight.mg,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),]))
#plot(pc2mod95_weight)
plot(lm(abs(quant_5)~mean.weight.mg,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),]))
```

###Magnitude + Direction

I will now look at the effect of species traits on the combination of magnitude and direction of shifts (real value) on PC1 and PC2. We'll start with running some models for PC1. 

####PC1

```{r}
##linear models
par(mfrow=c(2,2))
####shade tolerance
dm_pc1mod5_shade <- lm(quant_5~shade.tolerance*agent,pc1.diffs.traits)
anova(dm_pc1mod5_shade)
summary(dm_pc1mod5_shade)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod5_shade)
```

```{r}
dm_pc1mod50_shade <- lm(quant_50~shade.tolerance*agent,pc1.diffs.traits)
anova(dm_pc1mod50_shade)
summary(dm_pc1mod50_shade)
summary(lm(quant_50~shade.tolerance, pc1.diffs.traits))

qplot(shade.tolerance, quant_50, shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)

```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod50_shade)
```

```{r}
dm_pc1mod95_shade <- lm(quant_95~shade.tolerance*agent,pc1.diffs.traits)
anova(dm_pc1mod95_shade)
summary(dm_pc1mod95_shade)
```

```{r}
ggplot(pc1.diffs.traits,aes(x=shade.tolerance,y=quant_95,color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  scale_color_brewer(palette="Paired")+
  ylab("Difference in 95th quantile on PC1")+
  xlab("Shade Tolerance Score")+
  ggtitle("PC1 95th quantile")+
  theme(axis.text = element_text(color="black",size=11),text = element_text(size=11),legend.text = element_text(size=11),strip.text = element_text(color="black",size=11))
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod95_shade)
```

```{r}
####drought tolerance
dm_pc1mod5_drought <- lm(quant_5~drought.tolerance*agent,pc1.diffs.traits)
anova(dm_pc1mod5_drought)
summary(dm_pc1mod5_drought)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod5_drought)
```

```{r}
#significant interaction between drought tolerance and harvest for shifts in 5th percentile of PC1. Let's plot to see which direction this interaction is:
ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=quant_5,color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 5th quantile")+
  ylab("Shift")+
  xlab("Drought Tolerance Score")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

```

```{r}
dm_pc1mod50_drought <- lm(quant_50~drought.tolerance*agent,pc1.diffs.traits)
anova(dm_pc1mod50_drought)
summary(dm_pc1mod50_drought)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod50_drought)
```

```{r}
dm_pc1mod95_drought <- lm(quant_95~drought.tolerance*agent,pc1.diffs.traits)
anova(dm_pc1mod95_drought)
summary(dm_pc1mod95_drought)
summary(lm(quant_95~drought.tolerance, pc1.diffs.traits))
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod95_drought)
```

```{r}
ggplot(pc1.diffs.traits, aes(x=agent, y=quant_95))+
  geom_boxplot()
  

ggplot(pc1.diffs.traits, aes(x=drought.tolerance, y=quant_95,color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC1 95th quantile")+
  ylab("Difference in 95th quantile on PC1")+
  xlab("Drought Tolerance Score")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))


qplot(drought.tolerance, quant_95, shape = agent, color = agent, data = pc1.diffs.traits)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T)
```

```{r}
####seed weight
dm_pc1mod5_weight <- lm(quant_5~mean.weight.mg*agent,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),])
summary(dm_pc1mod5_weight)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod5_weight)
```

```{r}
dm_pc1mod50_weight <- lm(quant_50~mean.weight.mg*agent,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),])
summary(dm_pc1mod50_weight)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod50_weight)
```

```{r}
dm_pc1mod95_weight <- lm(quant_95~mean.weight.mg*agent,pc1.diffs.traits[!pc1.diffs.traits$species.code %in% c(814,106),])
summary(dm_pc1mod95_weight)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc1mod95_weight)
```


####PC2

And now for PC2:

```{r}
##linear models
par(mfrow=c(2,2))
####shade tolerance
dm_pc2mod5_shade <- lm(quant_5~shade.tolerance*agent,pc2.diffs.traits)
anova(dm_pc2mod5_shade)
summary(dm_pc2mod5_shade)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod5_shade)
```

```{r}
dm_pc2mod50_shade <- lm(quant_50~shade.tolerance*agent,pc2.diffs.traits)
anova(dm_pc2mod50_shade)
summary(dm_pc2mod50_shade)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod50_shade)
```

```{r}
dm_pc2mod95_shade <- lm(quant_95~shade.tolerance*agent,pc2.diffs.traits)
anova(dm_pc2mod95_shade)
summary(dm_pc2mod95_shade)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod95_shade)
```

```{r}
####drought tolerance
dm_pc2mod5_drought <- lm(quant_5~drought.tolerance*agent,pc2.diffs.traits)
anova(dm_pc2mod5_drought)
summary(dm_pc2mod5_drought)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod5_drought)
```

```{r}
#marginal significant interaction between drought tolerance and harvest/none for shifts in 5th percentile of pc2. Let's plot to see which direction this interaction is:
ggplot(pc2.diffs.traits, aes(x=drought.tolerance, y=quant_5,color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("pc2 5th quantile")+
  ylab("Shift")+
  xlab("Drought Tolerance Score")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

```

```{r}
dm_pc2mod50_drought <- lm(quant_50~drought.tolerance*agent,pc2.diffs.traits)
anova(dm_pc2mod50_drought)
summary(dm_pc2mod50_drought)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod50_drought)
```

```{r}
dm_pc2mod95_drought <- lm(quant_95~drought.tolerance*agent,pc2.diffs.traits)
anova(dm_pc2mod95_drought)
summary(dm_pc2mod95_drought)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod95_drought)
```

```{r}
####seed weight
dm_pc2mod5_weight <- lm(quant_5~mean.weight.mg*agent,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),])
summary(dm_pc2mod5_weight)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod5_weight)
```

```{r}
ggplot(pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),], aes(x=mean.weight.mg, y=quant_5,color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 5th quantile")+
  ylab("Shift")+
  xlab("Seed Weight(mg)")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

```

```{r}
dm_pc2mod50_weight <- lm(quant_50~mean.weight.mg*agent,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),])
summary(dm_pc2mod50_weight)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod50_weight)
```

```{r}
ggplot(pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),], aes(x=mean.weight.mg, y=quant_50,color=species.name))+
  stat_smooth(method = "lm", col="black", lty=2)+
  geom_point(size=3)+
  facet_wrap(~agent)+
  scale_color_brewer(palette="Paired")+
  ggtitle("PC2 50th quantile")+
  ylab("Shift")+
  xlab("Seed Weight(mg)")+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))
```

```{r}
dm_pc2mod95_weight <- lm(quant_95~mean.weight.mg*agent,pc2.diffs.traits[!pc2.diffs.traits$species.code %in% c(814,106),])
summary(dm_pc2mod95_weight)
```

```{r, echo=FALSE, eval=FALSE}
plot(dm_pc2mod95_weight)
```


###Plots of Trait effects for ESA presentation
```{r}
#shade tolerance effects on pc1 50th quantile shifts
ggplot(pc1.diffs.traits,aes(x=shade.tolerance, y=abs(quant_50), shape = agent, color = agent))+
  geom_point(size=3)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T, size=1)+
  xlab("Shade Tolerance")+
  ylab("50th quantile shift magnitude")+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

 ggplot(pc1.diffs.traits,aes(x=shade.tolerance, y=quant_50, shape = agent, color = agent))+
  geom_point(size=3)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T, size=1)+
  xlab("Shade Tolerance")+
  ylab("50th quantile shift")+
  ylim(c(-0.075,0.125))+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))


#shade tolerance effects on pc1 95th quantile shifts
ggplot(pc1.diffs.traits,aes(x=shade.tolerance, y=abs(quant_95), shape = agent, color = agent))+
  geom_point(size=3)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T, size=1)+
  xlab("Shade Tolerance")+
  ylab("95th quantile shift magnitude")+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))

ggplot(pc1.diffs.traits,aes(x=shade.tolerance, y=quant_95, shape = agent, color = agent))+
  geom_point(size=3)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T, size=1)+
  xlab("Shade Tolerance")+
  ylab("95th quantile shift")+
  ylim(c(-0.2,0.2))+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))


#drought tolerance effects on pc1 95th quantile shifts

ggplot(pc1.diffs.traits,aes(x=drought.tolerance, y=abs(quant_95), shape = agent, color = agent))+
  geom_point(size=3)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T, size=1)+
  xlab("Drought Tolerance")+
  ylab("95th quantile shift magnitude")+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))


ggplot(pc1.diffs.traits,aes(x=drought.tolerance, y=quant_95, shape = agent, color = agent))+
  geom_point(size=3)+
  geom_smooth(method = "lm", se = FALSE, fullrange = T, size=1)+
  xlab("Drought Tolerance")+
  ylab("95th quantile shift")+
  ylim(c(-0.2,0.25))+
  theme_bw()+
  theme(axis.text = element_text(color="black",size=14),text = element_text(size=14),legend.text = element_text(size=14),strip.text = element_text(color="black",size=14))



```

##Time Since Disturbance Effects

Now I will explore how time since disturbance may be influencing shifts. I will narrow the plots in each disturbance category to only those that had a disturbance 5 or more years before monitoring. Since the FIA only measures conifer seedlings greater than 6in tall, we wouldn't expect these to show up in the first few years after a destructive disturbance. It looks like most plots were disturbed relatively recently, so it may not be possible to use this filter due to sample size - but definitely something to note in the discussion.

```{r}
#first explore time since disturbance of plots
dist %>% 
  group_by(Agent) %>% 
  dplyr::summarise(mean.TSD = mean(MEASYEAR - DSTRBYR),
            min.TSD = min(MEASYEAR - DSTRBYR),
            max.TSD = max(MEASYEAR - DSTRBYR))

ggplot(dist, aes(x=MEASYEAR - DSTRBYR))+
  geom_histogram()+
  facet_wrap(~Agent)

dist %>% 
  filter(MEASYEAR - DSTRBYR > 4) %>% 
  group_by(Agent) %>% 
  dplyr::summarise(n=n())
```

# Other

Here I calculate the centroids in PC space by taking the mean of PC1 coordinates and PC2 coordinates for each species, age, and disturbance agent.

```{r, eval=FALSE}
#calculate centroid in PCA space for adults in each disturbance type
adult_centroids <- data.frame()
for(i in 1:length(adult_data_pcapts)){
m <- adult_data_pcapts %>% 
  pluck(i) %>% 
  dplyr::summarise(SPCD = unique(SPCD), Agent = unique(Agent), mean.pc1 = mean(PC1), mean.pc2 = mean(PC2)) 

adult_centroids <- bind_rows(adult_centroids, m) %>% 
    unite(uid, c(SPCD,Agent), sep="_", remove=FALSE )
}
adult_centroids

#do the same for seedlings
seedling_centroids <- data.frame()
for(i in 1:length(seedling_data_pcapts)){
m <- seedling_data_pcapts %>% 
  pluck(i) %>% 
  dplyr::summarise(SPCD = unique(SPCD), Agent = unique(Agent), mean.pc1 = mean(PC1), mean.pc2 = mean(PC2)) 

seedling_centroids <- bind_rows(seedling_centroids, m) %>% 
    unite(uid, c(SPCD,Agent), sep="_", remove=FALSE )
}
seedling_centroids
```

```{r, eval=FALSE}
##calculating some numbers for McIntire Stennis report
adults
dist
species.names

options(scipen = 9999)

unique.plots <- adults %>% 
  filter(SPCD %in% species.names$species.code) %>% 
  bind_rows(seeds %>% 
              filter(SPCD %in% species.names$species.code)) %>% 
  ungroup %>% 
  dplyr::select(PLT_CN) %>%
  unique()

unique.plotsdist <- dist %>% 
  semi_join(unique.plots, by="PLT_CN")

dist %>% 
  semi_join(unique.plots, by="PLT_CN") %>% 
  group_by(Agent) %>% 
  dplyr::summarise(n = n())

dist %>% 
  semi_join(unique.plots, by="PLT_CN") %>% 
  group_by(Agent) %>% 
  dplyr::summarise(n = n(), max = max(DSTRBYR), min = min(DSTRBYR))

###look at condition data
cond <- read_csv("C:/Users/Katie/Google Drive/FIA project/compiled_data_annual2020/COND.csv")

plot.conds<- cond %>% 
  filter(PLT_CN %in% dist$PLT_CN)

nrow(plot.conds)
summary(plot.conds$COND_STATUS_CD)
plot.conds %>%
  group_by(COND_STATUS_CD) %>% 
  summarize(n=n())

unique.plots.cond <- cond %>% 
  filter(PLT_CN %in% unique.plotsdist$PLT_CN)
unique.plots.cond %>% 
  group_by(COND_STATUS_CD) %>% 
  summarize(n=n())

```

```{r, eval=FALSE}
###make maps for ECOL693 presentation
plot.cut <- plot %>% 
  right_join(dist,by=c("CN" = "PLT_CN"))
head(plot.cut)
nrow(plot.cut)

fire.locations <- plot.cut %>%
  filter(Agent == "fire") %>% 
  dplyr::select(LAT,LON)
none.locations <- plot.cut %>%
  filter(Agent == "none") %>% 
  dplyr::select(LAT,LON)
id.locations <- plot.cut %>%
  filter(Agent == "insect.disease") %>% 
  select(LAT,LON)
harvest.locations <- plot.cut %>%
  filter(Agent == "harvest") %>% 
  dplyr::select(LAT,LON)

usa <- map_data("usa")

ggplot()+
  geom_polygon(data=usa,aes(x=long,y=lat,group=group),fill="white",color="black")+
  geom_point(data=none.locations,aes(x=LON, y= LAT))+
  coord_fixed(1.3)

ggplot()+
  geom_polygon(data=usa,aes(x=long,y=lat,group=group),fill="white",color="black")+
  geom_point(data=none.locations,aes(x=LON, y= LAT), color="#C77CFF")+
  geom_point(data=fire.locations,aes(x=LON, y= LAT),color="#F8766D")+
  geom_point(data=id.locations,aes(x=LON, y= LAT),color="#00BFC4")+
  geom_point(data=harvest.locations,aes(x=LON, y= LAT),color="#7CAE00")+
  coord_fixed(1.3)

leaflet(none.locations) %>%
  addTiles() %>%
  addCircles(lng = ~LON, lat = ~LAT, color="purple")
leaflet(fire.locations) %>%
  addTiles() %>%
  addCircles(lng = ~LON, lat = ~LAT, color="red")
leaflet(id.locations) %>%
  addTiles() %>%
  addCircles(lng = ~LON, lat = ~LAT, color="blue")
leaflet(harvest.locations) %>%
  addTiles() %>%
  addCircles(lng = ~LON, lat = ~LAT, color="green")

```
